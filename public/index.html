<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡…åŸºæµåŠ¨APIç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .add-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .balance-text {
            font-weight: 500;
        }

        .balance-available {
            color: #27ae60;
        }

        .balance-insufficient {
            color: #e74c3c;
        }

        .balance-unknown {
            color: #95a5a6;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-insufficient {
            background: #f8d7da;
            color: #721c24;
        }

        .status-error {
            background: #fff3cd;
            color: #856404;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.show {
            display: block;
        }

        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .password-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
        }

        .password-box h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .password-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- å¯†ç è¾“å…¥ç•Œé¢ -->
    <div id="passwordModal" class="password-modal" style="display: none;">
        <div class="password-box">
            <h2>ğŸ”’ éœ€è¦ç®¡ç†å‘˜å¯†ç </h2>
            <form id="passwordForm">
                <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " required autofocus>
                <button type="submit" class="btn btn-primary" style="width: 100%;">éªŒè¯</button>
            </form>
            <div id="passwordAlert" class="alert" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="header">
                <h1>ğŸ”‘ ç¡…åŸºæµåŠ¨APIç®¡ç†</h1>
                <p>ç®¡ç†å’Œç›‘æ§æ‚¨çš„APIå¯†é’¥</p>
            </div>
            <div class="content">
                <div id="alert" class="alert"></div>
            
            <div class="add-section">
                <h2 style="margin-bottom: 15px; color: #333;">æ·»åŠ APIå¯†é’¥</h2>
                <form id="addForm">
                    <div class="form-group">
                        <label for="apiKeys">API Keyï¼ˆæ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰*</label>
                        <textarea id="apiKeys" name="apiKeys" placeholder="è¾“å…¥æ‚¨çš„ç¡…åŸºæµåŠ¨APIå¯†é’¥ï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ª" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ å¯†é’¥</button>
                </form>
            </div>

            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0; color: #333;">APIå¯†é’¥åˆ—è¡¨</h2>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="font-size: 16px; font-weight: 500;">
                            æ€»ä½™é¢: <span id="totalBalance" style="color: #27ae60; font-weight: 600;">Â¥0.00</span>
                        </div>
                        <button class="btn btn-primary" onclick="exportAllKeys()">å¯¼å‡ºå…¨éƒ¨</button>
                    </div>
                </div>
                <div id="loading" class="loading">åŠ è½½ä¸­...</div>
                <div id="empty" class="empty" style="display: none;">æš‚æ— APIå¯†é’¥ï¼Œè¯·æ·»åŠ </div>
                <table id="keysTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>API Key</th>
                            <th>å¯ç”¨çŠ¶æ€</th>
                            <th>ä½™é¢</th>
                            <th>è°ƒç”¨æ¬¡æ•°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æœ€åä½¿ç”¨</th>
                            <th>é”™è¯¯æ¬¡æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="keysTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // è·å–å­˜å‚¨çš„token
        function getAuthToken() {
            return localStorage.getItem('admin_token');
        }

        // è®¾ç½®token
        function setAuthToken(token) {
            localStorage.setItem('admin_token', token);
        }

        // æ¸…é™¤token
        function clearAuthToken() {
            localStorage.removeItem('admin_token');
        }

        // è·å–è¯·æ±‚å¤´ï¼ˆå¸¦è®¤è¯ä¿¡æ¯ï¼‰
        function getAuthHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            return headers;
        }

        // å¤„ç†401é”™è¯¯ï¼ˆéœ€è¦é‡æ–°éªŒè¯ï¼‰
        function handleAuthError() {
            clearAuthToken();
            showPasswordModal();
            showAlert('éœ€è¦é‡æ–°éªŒè¯å¯†ç ', 'error');
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¯†ç 
        async function checkAuth() {
            try {
                const response = await fetch('/api/manage/check-auth');
                const result = await response.json();
                
                if (result.success && result.requiresPassword) {
                    // éœ€è¦å¯†ç ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„token
                    const token = getAuthToken();
                    if (token) {
                        // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆï¼ˆé€šè¿‡å°è¯•è·å–API keysï¼‰
                        try {
                            const verifyResponse = await fetch('/api/manage/api-keys', {
                                headers: getAuthHeaders()
                            });
                            if (verifyResponse.ok) {
                                // tokenæœ‰æ•ˆï¼Œæ˜¾ç¤ºä¸»å†…å®¹å¹¶åŠ è½½æ•°æ®
                                showMainContent();
                                loadApiKeys();
                                return;
                            } else if (verifyResponse.status === 401) {
                                // tokenæ— æ•ˆï¼Œæ¸…é™¤å¹¶æ˜¾ç¤ºå¯†ç è¾“å…¥
                                clearAuthToken();
                                showPasswordModal();
                                return;
                            }
                        } catch (verifyError) {
                            // éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤tokenå¹¶æ˜¾ç¤ºå¯†ç è¾“å…¥
                            clearAuthToken();
                            showPasswordModal();
                            return;
                        }
                    }
                    // æ²¡æœ‰tokenï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
                    showPasswordModal();
                } else {
                    // ä¸éœ€è¦å¯†ç ï¼Œç›´æ¥æ˜¾ç¤ºä¸»å†…å®¹å¹¶åŠ è½½æ•°æ®
                    showMainContent();
                    loadApiKeys();
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä¹Ÿæ˜¾ç¤ºä¸»å†…å®¹å¹¶å°è¯•åŠ è½½æ•°æ®ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰
                showMainContent();
                loadApiKeys();
            }
        }

        // æ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('show');
        }

        // æ˜¾ç¤ºä¸»å†…å®¹
        function showMainContent() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºå¯†ç é”™è¯¯æç¤º
        function showPasswordAlert(message, type = 'error') {
            const alert = document.getElementById('passwordAlert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
        }

        // å¯†ç éªŒè¯
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            try {
                const response = await fetch('/api/manage/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();
                if (result.success) {
                    // å¯†ç æ­£ç¡®ï¼Œä¿å­˜tokenå¹¶æ˜¾ç¤ºä¸»å†…å®¹
                    setAuthToken(password);
                    showPasswordAlert('éªŒè¯æˆåŠŸ', 'success');
                    setTimeout(() => {
                        showMainContent();
                        loadApiKeys();
                    }, 500);
                } else {
                    // å¯†ç é”™è¯¯
                    showPasswordAlert(result.message || 'å¯†ç é”™è¯¯', 'error');
                    document.getElementById('adminPassword').value = '';
                }
            } catch (error) {
                showPasswordAlert('éªŒè¯å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åŠ è½½API keysåˆ—è¡¨
        async function loadApiKeys() {
            try {
                const response = await fetch('/api/manage/api-keys', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (result.success && result.data.length > 0) {
                    document.getElementById('keysTable').style.display = 'table';
                    document.getElementById('empty').style.display = 'none';
                    renderTable(result.data);
                } else {
                    document.getElementById('keysTable').style.display = 'none';
                    document.getElementById('empty').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showAlert('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å­˜å‚¨å®Œæ•´çš„API keysï¼ˆç”¨äºå¤åˆ¶ï¼‰
        let fullApiKeysMap = {};

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(keys) {
            const tbody = document.getElementById('keysTableBody');
            let totalBalance = 0;
            
            // æ¸…ç©ºå¹¶é‡æ–°æ„å»ºå®Œæ•´keyæ˜ å°„
            fullApiKeysMap = {};
            keys.forEach(key => {
                if (key.full_api_key) {
                    fullApiKeysMap[key.id] = key.full_api_key;
                }
            });
            
            tbody.innerHTML = keys.map((key, index) => {
                // å¯ç”¨çŠ¶æ€æ˜¾ç¤º
                const isAvailable = key.is_available === true || key.is_available === 1 || key.is_available === null;
                const availableText = isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨';
                const availableClass = isAvailable ? 'status-active' : 'status-insufficient';

                const createdDate = key.created_at ? new Date(key.created_at).toLocaleString('zh-CN') : '-';
                const lastUsed = key.last_used_at ? new Date(key.last_used_at).toLocaleString('zh-CN') : '-';
                
                // ä½™é¢æ˜¾ç¤ºï¼ˆé‡‘é¢ï¼‰
                let balanceDisplay = 'æœªæŸ¥è¯¢';
                let balanceClass = 'balance-unknown';
                let balanceValue = 0;
                if (key.balance !== null && key.balance !== undefined) {
                    balanceValue = parseFloat(key.balance);
                    balanceDisplay = `Â¥${balanceValue.toFixed(2)}`;
                    balanceClass = balanceValue >= 0.5 ? 'balance-available' : 'balance-insufficient';
                    totalBalance += balanceValue;
                }

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td id="api-key-cell-${key.id}" style="cursor: pointer; user-select: none;" onclick="copyApiKey(${key.id})" title="ç‚¹å‡»å¤åˆ¶å®Œæ•´å¯†é’¥">${escapeHtml(key.api_key)}</td>
                        <td>
                            <span class="status-badge ${availableClass}" style="cursor: pointer;" onclick="toggleAvailability(${key.id})" title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€">${availableText}</span>
                        </td>
                        <td>
                            <span class="balance-text ${balanceClass}" id="balance-${key.id}">${balanceDisplay}</span>
                        </td>
                        <td>${key.call_count || 0}</td>
                        <td>${createdDate}</td>
                        <td>${lastUsed}</td>
                        <td>${key.error_count || 0}</td>
                        <td class="actions">
                            <button class="btn btn-info btn-small" onclick="queryBalance(${key.id})" id="query-btn-${key.id}">æŸ¥è¯¢ä½™é¢</button>
                            <button class="btn btn-danger btn-small" onclick="deleteKey(${key.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // æ›´æ–°æ€»ä½™é¢æ˜¾ç¤º
            document.getElementById('totalBalance').textContent = `Â¥${totalBalance.toFixed(2)}`;
        }

        // æ·»åŠ API keyï¼ˆæ”¯æŒæ‰¹é‡ï¼‰
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const apiKeys = document.getElementById('apiKeys').value.trim();

            if (!apiKeys) {
                showAlert('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }

            try {
                const response = await fetch('/api/manage/api-keys', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        api_keys: apiKeys
                    })
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    const message = result.added > 0 
                        ? `æˆåŠŸæ·»åŠ  ${result.added} ä¸ªå¯†é’¥${result.errors ? `ï¼Œ${result.errors.length} ä¸ªå¤±è´¥` : ''}`
                        : 'æ·»åŠ å¤±è´¥';
                    showAlert(message, result.added > 0 ? 'success' : 'error');
                    document.getElementById('addForm').reset();
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ é™¤API key
        async function deleteKey(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå¯†é’¥å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/manage/api-keys/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showAlert('åˆ é™¤æˆåŠŸ');
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥è¯¢ä½™é¢
        async function queryBalance(id) {
            const btn = document.getElementById(`query-btn-${id}`);
            const balanceEl = document.getElementById(`balance-${id}`);
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';
            balanceEl.textContent = 'æŸ¥è¯¢ä¸­...';
            
            try {
                const response = await fetch(`/api/manage/api-keys/${id}/balance`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // æ˜¾ç¤ºä½™é¢é‡‘é¢
                    if (result.data.balance !== null && result.data.balance !== undefined) {
                        balanceEl.textContent = `Â¥${parseFloat(result.data.balance).toFixed(2)}`;
                        balanceEl.className = `balance-text ${
                            parseFloat(result.data.balance) >= 0.5 ? 'balance-available' : 'balance-insufficient'
                        }`;
                    } else {
                        balanceEl.textContent = 'æ— æ³•è·å–';
                        balanceEl.className = 'balance-text balance-unknown';
                    }
                    showAlert(result.data.message);
                    // å¦‚æœçŠ¶æ€å˜åŒ–ï¼Œé‡æ–°åŠ è½½åˆ—è¡¨
                    setTimeout(() => loadApiKeys(), 500);
                } else {
                    balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                    balanceEl.className = 'balance-text balance-unknown';
                    showAlert(result.message || 'æŸ¥è¯¢å¤±è´¥', 'error');
                }
            } catch (error) {
                balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                balanceEl.className = 'balance-text balance-unknown';
                showAlert('æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢ä½™é¢';
            }
        }

        // å¤åˆ¶API key
        async function copyApiKey(keyId) {
            // ä»æ˜ å°„ä¸­è·å–å®Œæ•´çš„API key
            const fullKey = fullApiKeysMap[keyId];
            if (!fullKey) {
                showAlert('æ— æ³•è·å–å®Œæ•´å¯†é’¥', 'error');
                return;
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„tdå…ƒç´ ç”¨äºè§†è§‰åé¦ˆ
            const targetElement = document.getElementById(`api-key-cell-${keyId}`);
            
            try {
                // ä½¿ç”¨Clipboard APIå¤åˆ¶
                await navigator.clipboard.writeText(fullKey);
                
                // è§†è§‰åé¦ˆï¼šä¸´æ—¶æ”¹å˜æ–‡æœ¬
                if (targetElement) {
                    const originalText = targetElement.textContent;
                    targetElement.textContent = 'å·²å¤åˆ¶ï¼';
                    targetElement.style.color = '#27ae60';
                    targetElement.style.fontWeight = '600';
                    
                    setTimeout(() => {
                        targetElement.textContent = originalText;
                        targetElement.style.color = '';
                        targetElement.style.fontWeight = '';
                    }, 1500);
                }
                
                showAlert('APIå¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = fullKey;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    if (targetElement) {
                        const originalText = targetElement.textContent;
                        targetElement.textContent = 'å·²å¤åˆ¶ï¼';
                        targetElement.style.color = '#27ae60';
                        targetElement.style.fontWeight = '600';
                        
                        setTimeout(() => {
                            targetElement.textContent = originalText;
                            targetElement.style.color = '';
                            targetElement.style.fontWeight = '';
                        }, 1500);
                    }
                    
                    showAlert('APIå¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }

        // åˆ‡æ¢å¯ç”¨çŠ¶æ€
        async function toggleAvailability(id) {
            try {
                const response = await fetch(`/api/manage/api-keys/${id}/toggle-availability`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showAlert(result.message);
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'åˆ‡æ¢å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºæ‰€æœ‰API keys
        async function exportAllKeys() {
            try {
                const token = getAuthToken();
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/manage/api-keys/export', {
                    headers: headers
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                if (!response.ok) {
                    const result = await response.json();
                    showAlert(result.message || 'å¯¼å‡ºå¤±è´¥', 'error');
                    return;
                }

                // è·å–æ–‡ä»¶å†…å®¹
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'api_keys.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('å¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                showAlert('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯å¹¶åŠ è½½åˆ—è¡¨
        checkAuth();
    </script>
</body>
</html>

