<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡…åŸºæµåŠ¨APIç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .add-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .balance-text {
            font-weight: 500;
        }

        .balance-available {
            color: #27ae60;
        }

        .balance-insufficient {
            color: #e74c3c;
        }

        .balance-unknown {
            color: #95a5a6;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr.using-key {
            background: #e8f5e9 !important;
            border-left: 3px solid #27ae60;
        }

        tr.using-key:hover {
            background: #d4edda !important;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-insufficient {
            background: #f8d7da;
            color: #721c24;
        }

        .status-error {
            background: #fff3cd;
            color: #856404;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.show {
            display: block;
        }

        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .password-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
        }

        .log-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .log-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            max-height: 60vh;
        }

        .log-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #e74c3c;
        }

        .log-time {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .log-error {
            color: #e74c3c;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .password-box h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .password-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- å¯†ç è¾“å…¥ç•Œé¢ -->
    <div id="passwordModal" class="password-modal" style="display: none;">
        <div class="password-box">
            <h2>ğŸ”’ éœ€è¦ç®¡ç†å‘˜å¯†ç </h2>
            <form id="passwordForm">
                <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " required autofocus>
                <button type="submit" class="btn btn-primary" style="width: 100%;">éªŒè¯</button>
            </form>
            <div id="passwordAlert" class="alert" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- é”™è¯¯æ—¥å¿—æŸ¥çœ‹ç•Œé¢ -->
    <div id="logModal" class="log-modal" style="display: none;">
        <div class="log-box">
            <div class="log-header">
                <h2>ğŸ“‹ é”™è¯¯æ—¥å¿—</h2>
                <button class="btn btn-danger" onclick="closeLogModal()" style="padding: 8px 16px;">å…³é—­</button>
            </div>
            <div id="logContent" class="log-content">
                <div style="text-align: center; color: #999; padding: 20px;">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="header">
                <h1>ğŸ”‘ ç¡…åŸºæµåŠ¨APIç®¡ç†</h1>
                <p>ç®¡ç†å’Œç›‘æ§æ‚¨çš„APIå¯†é’¥</p>
            </div>
            <div class="content">
                <div id="alert" class="alert"></div>
            
            <div class="add-section">
                <h2 style="margin-bottom: 15px; color: #333;">æ·»åŠ APIå¯†é’¥</h2>
                <form id="addForm">
                    <div class="form-group">
                        <label for="apiKeys">API Keyï¼ˆæ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰*</label>
                        <textarea id="apiKeys" name="apiKeys" placeholder="è¾“å…¥æ‚¨çš„ç¡…åŸºæµåŠ¨APIå¯†é’¥ï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ª" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ å¯†é’¥</button>
                </form>
            </div>

            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex: 1; min-width: 300px;">
                        <h2 style="margin: 0; color: #333;">APIå¯†é’¥åˆ—è¡¨</h2>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; background: #e8f4f8; padding: 6px 12px; border-radius: 4px; border-left: 3px solid #3498db;">
                            <span style="font-weight: 500;">APIåœ°å€ï¼š</span>
                            <span id="apiUrlText" style="font-family: 'Courier New', monospace; color: #2c3e50;">åŠ è½½ä¸­...</span>
                            <button onclick="copyApiUrl()" class="btn btn-info btn-small" style="padding: 2px 8px; font-size: 11px; margin-left: 4px;">å¤åˆ¶</button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="font-size: 16px; font-weight: 500;">
                            æ€»ä½™é¢: <span id="totalBalance" style="color: #27ae60; font-weight: 600;">Â¥0.00</span>
                        </div>
                        <button class="btn btn-primary" onclick="exportAllKeys()">å¯¼å‡ºå…¨éƒ¨</button>
                        <button class="btn btn-info" onclick="queryAllBalances()" id="queryAllBtn">ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢</button>
                    </div>
                </div>
                <div id="loading" class="loading">åŠ è½½ä¸­...</div>
                <div id="empty" class="empty" style="display: none;">æš‚æ— APIå¯†é’¥ï¼Œè¯·æ·»åŠ </div>
                <table id="keysTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>API Key</th>
                            <th>å¯ç”¨çŠ¶æ€</th>
                            <th>ä½™é¢</th>
                            <th>è°ƒç”¨æ¬¡æ•°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æœ€åä½¿ç”¨</th>
                            <th>é”™è¯¯æ¬¡æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="keysTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // è·å–å­˜å‚¨çš„token
        function getAuthToken() {
            return localStorage.getItem('admin_token');
        }

        // è®¾ç½®token
        function setAuthToken(token) {
            localStorage.setItem('admin_token', token);
        }

        // æ¸…é™¤token
        function clearAuthToken() {
            localStorage.removeItem('admin_token');
        }

        // è·å–è¯·æ±‚å¤´ï¼ˆå¸¦è®¤è¯ä¿¡æ¯ï¼‰
        function getAuthHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            return headers;
        }

        // å¤„ç†401é”™è¯¯ï¼ˆéœ€è¦é‡æ–°éªŒè¯ï¼‰
        function handleAuthError() {
            clearAuthToken();
            showPasswordModal();
            showAlert('éœ€è¦é‡æ–°éªŒè¯å¯†ç ', 'error');
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¯†ç 
        async function checkAuth() {
            try {
                const response = await fetch('/api/manage/check-auth');
                const result = await response.json();
                
                if (result.success && result.requiresPassword) {
                    // éœ€è¦å¯†ç ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„token
                    const token = getAuthToken();
                    if (token) {
                        // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆï¼ˆé€šè¿‡å°è¯•è·å–API keysï¼‰
                        try {
                            const verifyResponse = await fetch('/api/manage/api-keys', {
                                headers: getAuthHeaders()
                            });
                            if (verifyResponse.ok) {
                                // tokenæœ‰æ•ˆï¼Œæ˜¾ç¤ºä¸»å†…å®¹å¹¶åŠ è½½æ•°æ®
                                showMainContent();
                                loadApiKeys();
                                return;
                            } else if (verifyResponse.status === 401) {
                                // tokenæ— æ•ˆï¼Œæ¸…é™¤å¹¶æ˜¾ç¤ºå¯†ç è¾“å…¥
                                clearAuthToken();
                                showPasswordModal();
                                return;
                            }
                        } catch (verifyError) {
                            // éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤tokenå¹¶æ˜¾ç¤ºå¯†ç è¾“å…¥
                            clearAuthToken();
                            showPasswordModal();
                            return;
                        }
                    }
                    // æ²¡æœ‰tokenï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
                    showPasswordModal();
                } else {
                    // ä¸éœ€è¦å¯†ç ï¼Œç›´æ¥æ˜¾ç¤ºä¸»å†…å®¹å¹¶åŠ è½½æ•°æ®
                    showMainContent();
                    loadApiKeys();
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä¹Ÿæ˜¾ç¤ºä¸»å†…å®¹å¹¶å°è¯•åŠ è½½æ•°æ®ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰
                showMainContent();
                loadApiKeys();
            }
        }

        // æ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('show');
        }

        // æ˜¾ç¤ºä¸»å†…å®¹
        function showMainContent() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºå¯†ç é”™è¯¯æç¤º
        function showPasswordAlert(message, type = 'error') {
            const alert = document.getElementById('passwordAlert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
        }

        // å¯†ç éªŒè¯
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            try {
                const response = await fetch('/api/manage/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();
                if (result.success) {
                    // å¯†ç æ­£ç¡®ï¼Œä¿å­˜tokenå¹¶æ˜¾ç¤ºä¸»å†…å®¹
                    setAuthToken(password);
                    showPasswordAlert('éªŒè¯æˆåŠŸ', 'success');
                    setTimeout(() => {
                        showMainContent();
                        loadApiKeys();
                    }, 500);
                } else {
                    // å¯†ç é”™è¯¯
                    showPasswordAlert(result.message || 'å¯†ç é”™è¯¯', 'error');
                    document.getElementById('adminPassword').value = '';
                }
            } catch (error) {
                showPasswordAlert('éªŒè¯å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åŠ è½½API keysåˆ—è¡¨
        async function loadApiKeys() {
            try {
                const response = await fetch('/api/manage/api-keys', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (result.success && result.data.length > 0) {
                    document.getElementById('keysTable').style.display = 'table';
                    document.getElementById('empty').style.display = 'none';
                    renderTable(result.data);
                } else {
                    document.getElementById('keysTable').style.display = 'none';
                    document.getElementById('empty').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showAlert('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ ¼å¼åŒ–æ—¶é—´ä¸ºä¸­å›½æ—¶åŒºï¼ˆUTC+8ï¼‰
        // æ•°æ®åº“å­˜å‚¨çš„æ˜¯ UTC æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:mm:ssï¼Œæ— æ—¶åŒºä¿¡æ¯ï¼‰
        // éœ€è¦å°†å…¶è§£æä¸º UTC æ—¶é—´ï¼Œç„¶åè½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼ˆUTC+8ï¼‰æ˜¾ç¤º
        function formatChinaTime(dateString) {
            if (!dateString) return '-';
            try {
                // å¦‚æœæ—¶é—´å­—ç¬¦ä¸²æ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:mm:ssï¼‰
                // SQLite çš„ CURRENT_TIMESTAMP è¿”å›çš„æ˜¯ UTC æ—¶é—´
                // éœ€è¦å°†å…¶è§£æä¸º UTC æ—¶é—´ï¼ˆ+00:00ï¼‰ï¼Œç„¶åè½¬æ¢ä¸ºä¸­å›½æ—¶åŒºæ˜¾ç¤º
                let date;
                if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(dateString)) {
                    // æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ssï¼Œæ²¡æœ‰æ—¶åŒºä¿¡æ¯
                    // å°†å…¶è§£æä¸º UTC æ—¶é—´ï¼ˆ+00:00ï¼‰
                    date = new Date(dateString + '+00:00');
                } else {
                    // å¦‚æœå·²ç»æœ‰æ—¶åŒºä¿¡æ¯ï¼Œç›´æ¥è§£æ
                    date = new Date(dateString);
                }
                
                // éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    return '-';
                }
                
                // ä½¿ç”¨ toLocaleString è½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼ˆAsia/Shanghaiï¼ŒUTC+8ï¼‰
                const options = {
                    timeZone: 'Asia/Shanghai',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                const chinaTimeString = date.toLocaleString('zh-CN', options);
                // æ ¼å¼åŒ–ä¸ºï¼šYYYY/MM/DD HH:mm:ss
                // toLocaleString è¿”å›æ ¼å¼å¯èƒ½æ˜¯ "YYYY/M/D HH:mm:ss"ï¼Œéœ€è¦è¡¥é›¶
                const parts = chinaTimeString.split(' ');
                const datePart = parts[0].split('/');
                const timePart = parts[1].split(':');
                const year = datePart[0];
                const month = datePart[1].padStart(2, '0');
                const day = datePart[2].padStart(2, '0');
                const hours = timePart[0].padStart(2, '0');
                const minutes = timePart[1].padStart(2, '0');
                const seconds = timePart[2].padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return '-';
            }
        }

        // å­˜å‚¨å®Œæ•´çš„API keysï¼ˆç”¨äºå¤åˆ¶ï¼‰
        let fullApiKeysMap = {};
        // å½“å‰æ­£åœ¨ä½¿ç”¨çš„API key ID
        let currentUsingKeyId = null;

        // è·å–å½“å‰æ­£åœ¨ä½¿ç”¨çš„API key ID
        async function fetchCurrentApiKey() {
            try {
                const response = await fetch('/api/manage/current-api-key', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    currentUsingKeyId = result.data.current_api_key_id;
                    // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
                    updateTableHighlight();
                }
            } catch (error) {
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
                console.warn('è·å–å½“å‰API keyå¤±è´¥:', error);
            }
        }

        // æ›´æ–°è¡¨æ ¼é«˜äº®æ˜¾ç¤º
        function updateTableHighlight() {
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('tr').forEach(row => {
                row.classList.remove('using-key');
            });
            
            // é«˜äº®å½“å‰ä½¿ç”¨çš„API key
            if (currentUsingKeyId) {
                const row = document.querySelector(`tr[data-key-id="${currentUsingKeyId}"]`);
                if (row) {
                    row.classList.add('using-key');
                }
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(keys) {
            const tbody = document.getElementById('keysTableBody');
            let totalBalance = 0;
            
            // æ¸…ç©ºå¹¶é‡æ–°æ„å»ºå®Œæ•´keyæ˜ å°„
            fullApiKeysMap = {};
            keys.forEach(key => {
                if (key.full_api_key) {
                    fullApiKeysMap[key.id] = key.full_api_key;
                }
            });
            
            tbody.innerHTML = keys.map((key, index) => {
                // å¯ç”¨çŠ¶æ€æ˜¾ç¤º
                const isAvailable = key.is_available === true || key.is_available === 1 || key.is_available === null;
                const isError = key.status === 'error';
                let availableText = isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨';
                let availableClass = isAvailable ? 'status-active' : 'status-insufficient';
                
                // å¦‚æœçŠ¶æ€æ˜¯errorï¼Œæ˜¾ç¤ºå¼‚å¸¸çŠ¶æ€ï¼ˆä½†ç”¨æˆ·ä»ç„¶å¯ä»¥åˆ‡æ¢å¯ç”¨/ä¸å¯ç”¨ï¼‰
                if (isError) {
                    availableText = 'å¼‚å¸¸';
                    availableClass = 'status-error';
                }

                const createdDate = formatChinaTime(key.created_at);
                const lastUsed = formatChinaTime(key.last_used_at);
                
                // ä½™é¢æ˜¾ç¤ºï¼ˆé‡‘é¢ï¼‰
                let balanceDisplay = 'æœªæŸ¥è¯¢';
                let balanceClass = 'balance-unknown';
                let balanceValue = 0;
                if (key.balance !== null && key.balance !== undefined) {
                    balanceValue = parseFloat(key.balance);
                    balanceDisplay = `Â¥${balanceValue.toFixed(2)}`;
                    balanceClass = balanceValue >= 0.5 ? 'balance-available' : 'balance-insufficient';
                    totalBalance += balanceValue;
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨çš„API key
                const isCurrentUsing = currentUsingKeyId === key.id;
                const usingIndicator = isCurrentUsing ? '<span style="color: #27ae60; font-weight: bold; margin-left: 5px;" title="æ­£åœ¨ä½¿ç”¨">â—</span>' : '';
                
                return `
                    <tr data-key-id="${key.id}" class="${isCurrentUsing ? 'using-key' : ''}">
                        <td>${index + 1}</td>
                        <td id="api-key-cell-${key.id}" style="cursor: pointer; user-select: none;" onclick="copyApiKey(${key.id})" title="ç‚¹å‡»å¤åˆ¶å®Œæ•´å¯†é’¥">${escapeHtml(key.api_key)}${usingIndicator}</td>
                        <td>
                            <span class="status-badge ${availableClass}" style="cursor: pointer;" onclick="toggleAvailability(${key.id})" title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€">${availableText}</span>
                        </td>
                        <td>
                            <span class="balance-text ${balanceClass}" id="balance-${key.id}">${balanceDisplay}</span>
                        </td>
                        <td>${key.call_count || 0}</td>
                        <td>${createdDate}</td>
                        <td>${lastUsed}</td>
                        <td>${key.error_count || 0}</td>
                        <td class="actions">
                            <button class="btn btn-info btn-small" onclick="queryBalance(${key.id})" id="query-btn-${key.id}">æŸ¥è¯¢ä½™é¢</button>
                            <button class="btn btn-warning btn-small" onclick="viewErrorLogs(${key.id})" title="æŸ¥çœ‹é”™è¯¯æ—¥å¿—">æ—¥å¿—</button>
                            <button class="btn btn-danger btn-small" onclick="deleteKey(${key.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // æ›´æ–°æ€»ä½™é¢æ˜¾ç¤º
            document.getElementById('totalBalance').textContent = `Â¥${totalBalance.toFixed(2)}`;
            
            // æ›´æ–°è¡¨æ ¼é«˜äº®
            updateTableHighlight();
        }

        // æ·»åŠ API keyï¼ˆæ”¯æŒæ‰¹é‡ï¼‰
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const apiKeys = document.getElementById('apiKeys').value.trim();

            if (!apiKeys) {
                showAlert('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }

            try {
                const response = await fetch('/api/manage/api-keys', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        api_keys: apiKeys
                    })
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    const message = result.added > 0 
                        ? `æˆåŠŸæ·»åŠ  ${result.added} ä¸ªå¯†é’¥${result.errors ? `ï¼Œ${result.errors.length} ä¸ªå¤±è´¥` : ''}`
                        : 'æ·»åŠ å¤±è´¥';
                    showAlert(message, result.added > 0 ? 'success' : 'error');
                    document.getElementById('addForm').reset();
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ é™¤API key
        async function deleteKey(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå¯†é’¥å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/manage/api-keys/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showAlert('åˆ é™¤æˆåŠŸ');
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥è¯¢ä½™é¢
        async function queryBalance(id) {
            const btn = document.getElementById(`query-btn-${id}`);
            const balanceEl = document.getElementById(`balance-${id}`);
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';
            balanceEl.textContent = 'æŸ¥è¯¢ä¸­...';
            
            try {
                const response = await fetch(`/api/manage/api-keys/${id}/balance`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // æ˜¾ç¤ºä½™é¢é‡‘é¢
                    if (result.data.balance !== null && result.data.balance !== undefined) {
                        balanceEl.textContent = `Â¥${parseFloat(result.data.balance).toFixed(2)}`;
                        balanceEl.className = `balance-text ${
                            parseFloat(result.data.balance) >= 0.5 ? 'balance-available' : 'balance-insufficient'
                        }`;
                    } else {
                        balanceEl.textContent = 'æ— æ³•è·å–';
                        balanceEl.className = 'balance-text balance-unknown';
                    }
                    showAlert(result.data.message);
                    // å¦‚æœçŠ¶æ€å˜åŒ–ï¼Œé‡æ–°åŠ è½½åˆ—è¡¨
                    setTimeout(() => loadApiKeys(), 500);
                } else {
                    balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                    balanceEl.className = 'balance-text balance-unknown';
                    showAlert(result.message || 'æŸ¥è¯¢å¤±è´¥', 'error');
                }
            } catch (error) {
                balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                balanceEl.className = 'balance-text balance-unknown';
                showAlert('æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢ä½™é¢';
            }
        }

        // å¤åˆ¶API key
        async function copyApiKey(keyId) {
            // ä»æ˜ å°„ä¸­è·å–å®Œæ•´çš„API key
            const fullKey = fullApiKeysMap[keyId];
            if (!fullKey) {
                showAlert('æ— æ³•è·å–å®Œæ•´å¯†é’¥', 'error');
                return;
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„tdå…ƒç´ ç”¨äºè§†è§‰åé¦ˆ
            const targetElement = document.getElementById(`api-key-cell-${keyId}`);
            
            try {
                // ä½¿ç”¨Clipboard APIå¤åˆ¶
                await navigator.clipboard.writeText(fullKey);
                
                // è§†è§‰åé¦ˆï¼šä¸´æ—¶æ”¹å˜æ–‡æœ¬
                if (targetElement) {
                    const originalText = targetElement.textContent;
                    targetElement.textContent = 'å·²å¤åˆ¶ï¼';
                    targetElement.style.color = '#27ae60';
                    targetElement.style.fontWeight = '600';
                    
                    setTimeout(() => {
                        targetElement.textContent = originalText;
                        targetElement.style.color = '';
                        targetElement.style.fontWeight = '';
                    }, 1500);
                }
                
                showAlert('APIå¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = fullKey;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    if (targetElement) {
                        const originalText = targetElement.textContent;
                        targetElement.textContent = 'å·²å¤åˆ¶ï¼';
                        targetElement.style.color = '#27ae60';
                        targetElement.style.fontWeight = '600';
                        
                        setTimeout(() => {
                            targetElement.textContent = originalText;
                            targetElement.style.color = '';
                            targetElement.style.fontWeight = '';
                        }, 1500);
                    }
                    
                    showAlert('APIå¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }

        // åˆ‡æ¢å¯ç”¨çŠ¶æ€
        async function toggleAvailability(id) {
            try {
                const response = await fetch(`/api/manage/api-keys/${id}/toggle-availability`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showAlert(result.message);
                    // å¦‚æœåˆ‡æ¢ä¸ºå¯ç”¨ï¼Œä¸”ä¹‹å‰æ˜¯å¼‚å¸¸çŠ¶æ€ï¼Œéœ€è¦æ¸…é™¤å¼‚å¸¸çŠ¶æ€
                    // æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯åˆ‡æ¢å¯ç”¨/ä¸å¯ç”¨ï¼Œå¼‚å¸¸çŠ¶æ€ç”±åå°è‡ªåŠ¨ç®¡ç†
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'åˆ‡æ¢å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥çœ‹é”™è¯¯æ—¥å¿—
        async function viewErrorLogs(id) {
            try {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('logModal').style.display = 'flex';
                document.getElementById('logContent').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">åŠ è½½ä¸­...</div>';

                const response = await fetch(`/api/manage/api-keys/${id}/logs`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    closeLogModal();
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    const logs = result.data;
                    
                    if (logs.length === 0) {
                        document.getElementById('logContent').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— é”™è¯¯æ—¥å¿—</div>';
                    } else {
                        const logsHtml = logs.map(log => {
                            const time = formatChinaTime(log.timestamp);
                            let errorText = log.error || 'æœªçŸ¥é”™è¯¯';
                            
                            // å°è¯•è§£æJSONæ ¼å¼çš„é”™è¯¯ä¿¡æ¯
                            try {
                                const errorObj = JSON.parse(errorText);
                                if (errorObj.data) {
                                    errorText = JSON.stringify(errorObj, null, 2);
                                }
                            } catch (e) {
                                // ä¸æ˜¯JSONï¼Œç›´æ¥ä½¿ç”¨
                            }
                            
                            return `
                                <div class="log-item">
                                    <div class="log-time">${time}</div>
                                    <div class="log-error">${escapeHtml(errorText)}</div>
                                </div>
                            `;
                        }).join('');
                        
                        document.getElementById('logContent').innerHTML = logsHtml;
                    }
                } else {
                    document.getElementById('logContent').innerHTML = `<div style="text-align: center; color: #e74c3c; padding: 20px;">${result.message || 'åŠ è½½å¤±è´¥'}</div>`;
                }
            } catch (error) {
                document.getElementById('logContent').innerHTML = `<div style="text-align: center; color: #e74c3c; padding: 20px;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // å…³é—­æ—¥å¿—æ¨¡æ€æ¡†
        function closeLogModal() {
            document.getElementById('logModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', (e) => {
            const logModal = document.getElementById('logModal');
            if (e.target === logModal) {
                closeLogModal();
            }
        });

        // å¯¼å‡ºæ‰€æœ‰API keys
        async function exportAllKeys() {
            try {
                const token = getAuthToken();
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/manage/api-keys/export', {
                    headers: headers
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                if (!response.ok) {
                    const result = await response.json();
                    showAlert(result.message || 'å¯¼å‡ºå¤±è´¥', 'error');
                    return;
                }

                // è·å–æ–‡ä»¶å†…å®¹
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'api_keys.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('å¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                showAlert('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢
        async function queryAllBalances() {
            const btn = document.getElementById('queryAllBtn');
            if (btn.disabled) return;
            
            try {
                // è·å–æ‰€æœ‰API keys
                const response = await fetch('/api/manage/api-keys', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    showAlert('æ²¡æœ‰å¯æŸ¥è¯¢çš„APIå¯†é’¥', 'error');
                    return;
                }
                
                const keys = result.data;
                btn.disabled = true;
                btn.textContent = `æŸ¥è¯¢ä¸­ (0/${keys.length})...`;
                
                let successCount = 0;
                let failCount = 0;
                
                // ä¾æ¬¡æŸ¥è¯¢æ¯ä¸ªAPI keyçš„ä½™é¢
                for (let i = 0; i < keys.length; i++) {
                    const key = keys[i];
                    btn.textContent = `æŸ¥è¯¢ä¸­ (${i + 1}/${keys.length})...`;
                    
                    try {
                        const balanceResponse = await fetch(`/api/manage/api-keys/${key.id}/balance`, {
                            headers: getAuthHeaders()
                        });
                        
                        if (balanceResponse.status === 401) {
                            handleAuthError();
                            btn.disabled = false;
                            btn.textContent = 'ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢';
                            return;
                        }
                        
                        const balanceResult = await balanceResponse.json();
                        
                        if (balanceResult.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                        
                        // æ¯ä¸ªæŸ¥è¯¢ä¹‹é—´ç¨å¾®å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                        if (i < keys.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    } catch (error) {
                        failCount++;
                        console.error(`æŸ¥è¯¢ API Key ${key.id} ä½™é¢å¤±è´¥:`, error);
                    }
                }
                
                btn.disabled = false;
                btn.textContent = 'ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢';
                
                // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°ä½™é¢
                await loadApiKeys();
                
                showAlert(`æŸ¥è¯¢å®Œæˆï¼æˆåŠŸ: ${successCount}ï¼Œå¤±è´¥: ${failCount}`);
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢';
                showAlert('æ‰¹é‡æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·å–å¹¶æ˜¾ç¤ºAPIåœ°å€
        function updateApiUrl() {
            const protocol = window.location.protocol;
            const host = window.location.host;
            const apiUrl = `${protocol}//${host}/api/proxy/`;
            const apiUrlText = document.getElementById('apiUrlText');
            if (apiUrlText) {
                apiUrlText.textContent = apiUrl;
            }
        }

        // å¤åˆ¶APIåœ°å€
        async function copyApiUrl() {
            const protocol = window.location.protocol;
            const host = window.location.host;
            const apiUrl = `${protocol}//${host}/api/proxy/`;
            
            try {
                await navigator.clipboard.writeText(apiUrl);
                showAlert('APIåœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = apiUrl;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('APIåœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }

        // è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆæ¯10ç§’ï¼‰
        let autoRefreshInterval = null;
        let currentKeyRefreshInterval = null;
        
        function startAutoRefresh() {
            // æ¸…é™¤å·²æœ‰çš„å®šæ—¶å™¨
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (currentKeyRefreshInterval) {
                clearInterval(currentKeyRefreshInterval);
            }
            
            // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®
            autoRefreshInterval = setInterval(() => {
                // åªåœ¨é¡µé¢å¯è§æ—¶åˆ·æ–°ï¼ˆé¿å…åå°æ ‡ç­¾é¡µæµªè´¹èµ„æºï¼‰
                if (!document.hidden) {
                    loadApiKeys();
                }
            }, 10000); // 10ç§’ = 10000æ¯«ç§’
            
            // æ¯2ç§’åˆ·æ–°ä¸€æ¬¡å½“å‰ä½¿ç”¨çš„API keyï¼ˆæ›´é¢‘ç¹ï¼Œä»¥ä¾¿å®æ—¶æ˜¾ç¤ºï¼‰
            currentKeyRefreshInterval = setInterval(() => {
                // åªåœ¨é¡µé¢å¯è§æ—¶åˆ·æ–°
                if (!document.hidden) {
                    fetchCurrentApiKey();
                }
            }, 2000); // 2ç§’ = 2000æ¯«ç§’
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (currentKeyRefreshInterval) {
                clearInterval(currentKeyRefreshInterval);
                currentKeyRefreshInterval = null;
            }
        }
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶åœæ­¢è‡ªåŠ¨åˆ·æ–°
                stopAutoRefresh();
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh();
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯å¹¶åŠ è½½åˆ—è¡¨
        checkAuth();
        // æ›´æ–°APIåœ°å€æ˜¾ç¤º
        updateApiUrl();
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        startAutoRefresh();
        // ç«‹å³è·å–ä¸€æ¬¡å½“å‰ä½¿ç”¨çš„API key
        fetchCurrentApiKey();
    </script>
</body>
</html>

