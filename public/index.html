<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡…åŸºæµåŠ¨APIç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSSå˜é‡å®šä¹‰ - äº®è‰²æ¨¡å¼ */
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: white;
            --text-primary: #333;
            --text-secondary: #666;
            --text-inverse: white;
            --border-color: #eee;
            --table-header-bg: #f8f9fa;
            --table-row-hover: #f8f9fa;
            --table-using-bg: #e8f5e9;
            --table-using-hover: #d4edda;
            --status-active-bg: #d4edda;
            --status-active-text: #155724;
            --status-insufficient-bg: #f8d7da;
            --status-insufficient-text: #721c24;
            --status-error-bg: #fff3cd;
            --status-error-text: #856404;
            --input-bg: white;
            --input-border: #ddd;
            --modal-bg: white;
            --modal-header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --info-box-bg: #e3f2fd;
            --info-box-text: #1565c0;
            --info-box-border: #2196f3;
            --checkbox-bg: white;
            --checkbox-border: #ddd;
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* æš—é»‘æ¨¡å¼å˜é‡ */
        [data-theme="dark"] {
            --bg-gradient-start: #2d1b4e;
            --bg-gradient-end: #1a0d2e;
            --container-bg: #1e1e1e;
            --text-primary: #c8c8c8;
            --text-secondary: #9a9a9a;
            --text-inverse: #1e1e1e;
            --border-color: #333;
            --table-header-bg: #252525;
            --table-row-hover: #2a2a2a;
            --table-using-bg: #1a3a1a;
            --table-using-hover: #1f4a1f;
            --status-active-bg: #1a3a1a;
            --status-active-text: #81c784;
            --status-insufficient-bg: #3a1a1a;
            --status-insufficient-text: #ef5350;
            --status-error-bg: #3a2a1a;
            --status-error-text: #ffb74d;
            --input-bg: #2a2a2a;
            --input-border: #444;
            --modal-bg: #2a2a2a;
            --modal-header-bg: linear-gradient(135deg, #2d1b4e 0%, #1a0d2e 100%);
            --info-box-bg: #1a2332;
            --info-box-text: #90caf9;
            --info-box-border: #64b5f6;
            --checkbox-bg: #3a3a3a;
            --checkbox-border: #666;
            --header-text: #e8e8e8;
            --shadow: 0 10px 40px rgba(0,0,0,0.5);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.7);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .header {
            background: var(--modal-header-bg);
            color: var(--text-inverse);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            transition: background 0.3s ease;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .header h1 {
            color: var(--text-inverse);
            font-size: 20px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .header h1 {
            color: var(--header-text);
        }

        .header p {
            display: none;
        }

        .content {
            padding: 20px;
            background: var(--container-bg);
            transition: background 0.3s ease;
            position: relative;
        }


        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .balance-text {
            font-weight: 500;
        }

        .balance-available {
            color: #27ae60;
        }

        .balance-insufficient {
            color: #e74c3c;
        }

        .balance-unknown {
            color: #95a5a6;
        }

        .table-container {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        /* è¡¨æ ¼å¤´éƒ¨å·¥å…·æ æ ·å¼ */
        .table-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 16px;
            padding: 14px 18px;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: background 0.3s ease, border-color 0.3s ease;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            background: var(--container-bg);
        }

        .table-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
            min-width: 0;
        }

        .table-header-right {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-shrink: 0;
        }

        .table-title {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        .api-url-box {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--info-box-text);
            background: var(--info-box-bg);
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid var(--info-box-border);
            border-left: 3px solid var(--info-box-border);
            flex: 1;
            min-width: 0;
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .api-url-box {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .api-url-label {
            font-weight: 500;
            white-space: nowrap;
        }

        .api-url-text {
            font-family: 'Courier New', monospace;
            color: var(--info-box-text);
            font-size: 12px;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            transition: color 0.3s ease;
            cursor: text;
            user-select: all;
            margin-right: 4px;
        }

        .api-url-text:hover {
            overflow: visible;
            position: relative;
            z-index: 10;
        }

        .balance-display {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            padding: 10px 18px;
            background: var(--table-header-bg);
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .balance-label {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .balance-amount {
            color: #27ae60;
            font-weight: 700;
            font-size: 22px;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons .btn {
            padding: 8px 16px;
            font-size: 13px;
            white-space: nowrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        th {
            background: var(--table-header-bg);
            font-weight: 600;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            white-space: nowrap;
            text-align: center;
        }

        td {
            color: var(--text-primary);
            transition: color 0.3s ease;
            white-space: nowrap;
        }
        
        /* æ‰€æœ‰åˆ—éƒ½å®Œæ•´æ˜¾ç¤ºï¼Œä¸æˆªæ–­ */
        td {
            overflow: visible;
        }

        tr:hover {
            background: var(--table-row-hover);
            transition: background 0.3s ease;
        }

        tr.using-key {
            background: var(--table-using-bg) !important;
            border-left: 3px solid #27ae60;
        }

        tr.using-key:hover {
            background: var(--table-using-hover) !important;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: var(--status-active-bg);
            color: var(--status-active-text);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .status-insufficient {
            background: var(--status-insufficient-bg);
            color: var(--status-insufficient-text);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .status-error {
            background: var(--status-error-bg);
            color: var(--status-error-text);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        td.actions {
            width: 340px;
        }

        .actions {
            white-space: nowrap;
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            align-items: center;
            width: 100%;
            justify-content: center;
        }

        .actions .btn {
            flex-shrink: 0;
            white-space: nowrap;
            min-width: 60px;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 60px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        /* å…¨å±€å›ºå®šå®šä½çš„alertå®¹å™¨ */
        .alert-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            max-width: 600px;
            width: calc(100% - 40px);
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .alert {
            padding: 14px 20px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
            animation: slideDown 0.3s ease-out;
            word-wrap: break-word;
            line-height: 1.5;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: var(--status-active-bg);
            color: var(--status-active-text);
            border: 1px solid var(--status-active-text);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .alert-error {
            background: var(--status-insufficient-bg);
            color: var(--status-insufficient-text);
            border: 1px solid var(--status-insufficient-text);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .alert.show {
            display: block;
        }

        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .password-box {
            background: var(--modal-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 90%;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        .log-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1100;
        }

        .log-panel {
            width: 100%;
            max-width: 1200px;
            background: var(--container-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-panel-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .log-panel-title {
            margin: 0;
            font-size: 20px;
            color: var(--text-primary);
        }

        .log-panel-subtitle {
            margin: 4px 0 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .log-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .log-panel-body {
            padding: 0 24px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .log-table-wrapper {
            overflow-x: auto;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .log-table th,
        .log-table td {
            padding: 12px 10px;
            font-size: 13px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .log-table th:nth-child(1),
        .log-table td:nth-child(1) {
            width: 140px;
            white-space: nowrap;
        }
        
        .log-table th:nth-child(2),
        .log-table td:nth-child(2) {
            width: 70px;
            white-space: nowrap;
        }
        
        .log-table th:nth-child(3),
        .log-table td:nth-child(3) {
            width: 80px;
            white-space: nowrap;
        }
        
        .log-table th:nth-child(4),
        .log-table td:nth-child(4) {
            width: 80px;
            white-space: nowrap;
        }
        
        .log-table th:nth-child(5),
        .log-table td:nth-child(5) {
            width: 70px;
            white-space: nowrap;
        }
        
        .log-table th:nth-child(6),
        .log-table td:nth-child(6) {
            width: 80px;
            white-space: nowrap;
        }
        
        .log-table th:nth-child(7),
        .log-table td:nth-child(7) {
            width: 90px;
            white-space: nowrap;
        }
        
        .log-table th:nth-child(8),
        .log-table td:nth-child(8) {
            width: 350px;
            min-width: 300px;
            white-space: normal;
            word-break: break-word;
            text-align: left;
            padding-left: 12px;
            padding-right: 12px;
        }
        
        .log-table th:nth-child(9),
        .log-table td:nth-child(9) {
            width: 100px;
            white-space: nowrap;
        }

        .log-table th {
            background: var(--table-header-bg);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .log-table tbody tr:hover {
            background: var(--table-row-hover);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-success {
            background: rgba(39, 174, 96, 0.15);
            color: #27ae60;
        }

        .status-fail {
            background: rgba(231, 76, 60, 0.12);
            color: #e74c3c;
        }

        .response-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
            font-weight: 600;
        }

        .log-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .log-page-info {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .log-page-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .log-page-actions button,
        .log-page-actions select {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--container-bg);
            color: var(--text-primary);
            cursor: pointer;
        }

        .log-page-actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log-empty {
            text-align: center;
            padding: 32px 0;
            color: var(--text-secondary);
        }

        .log-detail-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1200;
        }

        .log-detail-box {
            width: 100%;
            max-width: 800px;
            background: var(--container-bg);
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .log-detail-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-detail-content {
            padding: 20px 24px 24px;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 12px;
        }

        .detail-section h4 {
            margin: 0 0 10px;
            font-size: 15px;
            color: var(--text-secondary);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
        }

        .detail-grid .item {
            background: var(--table-header-bg);
            border-radius: 6px;
            padding: 6px 10px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-grid .item label {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .detail-grid .item span {
            font-size: 12px;
            color: var(--text-primary);
        }

        .detail-grid .item-inline-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .detail-grid .item-inline {
            background: var(--table-header-bg);
            border-radius: 6px;
            padding: 6px 10px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-grid .item-inline label {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .detail-grid .item-inline span {
            font-size: 12px;
            color: var(--text-primary);
        }

        .single-line {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .detail-grid .item-full {
            grid-column: 1 / -1;
            background: var(--table-header-bg);
            border-radius: 6px;
            padding: 6px 10px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-grid .item-full label {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .detail-grid .item-full .url-text {
            font-size: 12px;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
        }

        .json-block {
            background: #0f172a;
            color: #d6f3ff;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            font-family: 'Fira Code', Consolas, 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        [data-theme="dark"] .json-block {
            background: #0b1220;
            color: #ccecff;
        }

        .password-box h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .password-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .password-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            backdrop-filter: blur(4px);
        }

        .add-modal.show {
            display: flex;
        }

        .add-box {
            background: var(--modal-bg);
            padding: 0;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            height: auto;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .add-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-header h2 {
            margin: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-header .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .add-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .add-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .add-body .form-group {
            margin-bottom: 20px;
        }

        .add-body .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .add-body .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            min-height: 300px;
            resize: vertical;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .key-count {
            margin-top: 10px;
            padding: 8px 12px;
            background: var(--table-header-bg);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .key-count .count-number {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .add-body .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-footer {
            padding: 20px 25px;
            background: var(--table-header-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .add-footer .btn {
            padding: 10px 24px;
            font-size: 14px;
        }

        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        /* å¢å¤§å¤é€‰æ¡†å°ºå¯¸ */
        .key-checkbox,
        #selectAll {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
            background-color: var(--checkbox-bg);
            border: 2px solid var(--checkbox-border);
            border-radius: 4px;
            transition: all 0.2s;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: relative;
        }

        .key-checkbox:checked,
        #selectAll:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .key-checkbox:checked::after,
        #selectAll:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .key-checkbox:hover,
        #selectAll:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        [data-theme="dark"] .key-checkbox,
        [data-theme="dark"] #selectAll {
            accent-color: #64b5f6;
            background-color: var(--checkbox-bg);
            border-color: var(--checkbox-border);
        }

        [data-theme="dark"] .key-checkbox:checked,
        [data-theme="dark"] #selectAll:checked {
            background-color: #64b5f6;
            border-color: #64b5f6;
        }

        [data-theme="dark"] .key-checkbox:hover,
        [data-theme="dark"] #selectAll:hover {
            border-color: #64b5f6;
        }
    </style>
</head>
<body>
    <!-- å…¨å±€Alertå®¹å™¨ - å›ºå®šåœ¨é¡¶éƒ¨ -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- å¯†ç è¾“å…¥ç•Œé¢ -->
    <div id="passwordModal" class="password-modal" style="display: none;">
        <div class="password-box">
            <h2>ğŸ”’ éœ€è¦ç®¡ç†å‘˜å¯†ç </h2>
            <form id="passwordForm">
                <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " required autofocus>
                <button type="submit" class="btn btn-primary" style="width: 100%;">éªŒè¯</button>
            </form>
            <div id="passwordAlert" class="alert" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- è¯·æ±‚æ—¥å¿—æŸ¥çœ‹ç•Œé¢ -->
    <div id="logModal" class="log-modal" style="display: none;">
        <div class="log-panel">
            <div class="log-panel-header">
                <div>
                    <h2 class="log-panel-title">è¯·æ±‚æ—¥å¿—</h2>
                    <p class="log-panel-subtitle" id="logSubtitle">è¯·é€‰æ‹©éœ€è¦æŸ¥çœ‹çš„API Key</p>
                </div>
                <button class="log-close-btn" onclick="closeLogModal()" aria-label="å…³é—­æ—¥å¿—">Ã—</button>
            </div>
            <div class="log-panel-body">
                <div class="log-table-wrapper">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>è¯·æ±‚ç±»å‹</th>
                                <th>å“åº”ç±»å‹</th>
                                <th>çŠ¶æ€ç </th>
                                <th>æ˜¯å¦ä½¿ç”¨ä»£ç†</th>
                                <th>è€—æ—¶(ms)</th>
                                <th>æ¨¡å‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody">
                            <tr>
                                <td colspan="9" class="log-empty">æš‚æ— æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="log-pagination">
                    <div class="log-page-info" id="logPageInfo">å…± 0 æ¡è®°å½•</div>
                    <div class="log-page-actions">
                        <label style="font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">
                            æ¯é¡µ
                            <select id="logPageSizeSelect" onchange="changeLogPageSize(this.value)">
                                <option value="15">15æ¡</option>
                                <option value="30">30æ¡</option>
                                <option value="50">50æ¡</option>
                            </select>
                        </label>
                        <button id="logPrevPage" onclick="changeLogPage(-1)">ä¸Šä¸€é¡µ</button>
                        <button id="logNextPage" onclick="changeLogPage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯·æ±‚è¯¦æƒ… -->
    <div id="logDetailModal" class="log-detail-modal" style="display: none;">
        <div class="log-detail-box">
            <div class="log-detail-header">
                <h3 style="margin: 0; font-size: 18px;">è¯·æ±‚è¯¦æƒ…</h3>
                <button class="log-close-btn" onclick="closeLogDetailModal()" aria-label="å…³é—­è¯¦æƒ…">Ã—</button>
            </div>
            <div id="logDetailContent" class="log-detail-content">
                <div class="log-empty">æš‚æ— è¯¦æƒ…</div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ APIå¯†é’¥æ¨¡æ€æ¡† -->
    <div id="addModal" class="add-modal">
        <div class="add-box">
            <div class="add-header">
                <h2>ğŸ”‘ æ·»åŠ APIå¯†é’¥</h2>
                <button class="close-btn" onclick="closeAddModal()" title="å…³é—­">Ã—</button>
            </div>
            <div class="add-body">
                <form id="addForm">
                    <div class="form-group">
                        <label for="apiKeys">API Keyï¼ˆæ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰*</label>
                        <textarea id="apiKeys" name="apiKeys" placeholder="è¾“å…¥æ‚¨çš„ç¡…åŸºæµåŠ¨APIå¯†é’¥ï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ª&#10;&#10;ç¤ºä¾‹ï¼š&#10;sk-xxxxxxxxxxxxx&#10;sk-yyyyyyyyyyyyy" required></textarea>
                        <div id="keyCount" class="key-count" style="display: none;">
                            <span>ğŸ“Š æ£€æµ‹åˆ°</span>
                            <span class="count-number" id="keyCountNumber">0</span>
                            <span>ä¸ªAPIå¯†é’¥</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="add-footer">
                <button type="button" class="btn" onclick="closeAddModal()" style="background: var(--table-header-bg); color: var(--text-primary); border: 1px solid var(--border-color);">å–æ¶ˆ</button>
                <button type="submit" form="addForm" class="btn btn-primary">æ·»åŠ å¯†é’¥</button>
            </div>
        </div>
    </div>

    <!-- ä»£ç†é…ç½®æ¨¡æ€æ¡† -->
    <div class="add-modal" id="proxyModal">
        <div class="add-box" style="max-width: 900px; min-height: 600px;">
            <div class="add-header">
                <h2>ğŸŒ ä»£ç†é…ç½®</h2>
                <button class="close-btn" onclick="closeProxyModal()" title="å…³é—­">Ã—</button>
            </div>
            <div class="add-body">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="proxyEnabled" onchange="toggleProxyEnabled()" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>å¯ç”¨ä»£ç†åŠŸèƒ½</span>
                    </label>
                    <p style="margin-top: 8px; color: var(--text-secondary); font-size: 12px;">
                        å¯ç”¨åï¼Œå½“ä¸ä¸Šæ¸¸é€šä¿¡å‡ºé”™æˆ–IPè¢«æ‹‰é»‘æ—¶ï¼Œå°†è‡ªåŠ¨å°è¯•ä½¿ç”¨ä»£ç†è¿›è¡Œé€šä¿¡
                    </p>
                </div>

                <div id="proxyConfigArea" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px; color: var(--text-primary);">ä»£ç†åˆ—è¡¨</h3>
                        <button class="btn btn-primary" onclick="addProxyConfig()" style="padding: 6px 12px; font-size: 12px;">+ æ·»åŠ ä»£ç†</button>
                    </div>
                    <div id="proxyList" style="margin-top: 15px;">
                        <!-- ä»£ç†åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div id="proxyStateInfo" style="margin-top: 20px; padding: 15px; background: var(--info-box-bg); border: 1px solid var(--info-box-border); border-radius: 8px; display: none;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-primary);">å½“å‰ä»£ç†çŠ¶æ€</h4>
                    <p id="proxyStateText" style="margin: 0; color: var(--info-box-text); font-size: 12px;"></p>
                </div>
            </div>
            <div class="add-footer">
                <button type="button" class="btn" onclick="closeProxyModal()" style="background: var(--table-header-bg); color: var(--text-primary); border: 1px solid var(--border-color);">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="header">
                <h1>ğŸ”‘ ç¡…åŸºæµåŠ¨APIç®¡ç†</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-info" onclick="showProxyModal()" style="padding: 8px 16px; font-size: 14px;">ğŸŒ ä»£ç†é…ç½®</button>
                    <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢æš—é»‘æ¨¡å¼">ğŸŒ™</button>
                </div>
            </div>
            <div class="content">
            <div class="table-container">
                <div class="table-header-bar">
                    <div class="table-header-left">
                        <!-- <h2 class="table-title">APIå¯†é’¥åˆ—è¡¨</h2> -->
                        <button class="btn btn-primary" onclick="showAddModal()">+ æ·»åŠ å¯†é’¥</button>
                        <div class="api-url-box">
                            <span class="api-url-label">APIåœ°å€ï¼š</span>
                            <span id="apiUrlText" class="api-url-text">åŠ è½½ä¸­...</span>
                            <button onclick="copyApiUrl()" class="btn btn-info btn-small">å¤åˆ¶</button>
                        </div>
                    </div>
                    <div class="table-header-right">
                        <div class="balance-display">
                            <span class="balance-label">æ€»ä½™é¢:</span>
                            <span id="totalBalance" class="balance-amount">Â¥0.00</span>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-info" onclick="batchQueryBalances()" id="batchQueryBtn" style="display: none;">æŸ¥è¯¢ (<span id="selectedQueryCount">0</span>)</button>
                            <button class="btn btn-danger" onclick="batchDeleteKeys()" id="batchDeleteBtn" style="display: none;">åˆ é™¤ (<span id="selectedDeleteCount">0</span>)</button>
                            <button class="btn btn-primary" onclick="exportAllKeys()">å¯¼å‡º</button>
                            <button class="btn btn-info" onclick="queryAllBalances()" id="queryAllBtn">æŸ¥è¯¢å…¨éƒ¨</button>
                        </div>
                    </div>
                </div>
                <div id="loading" class="loading">åŠ è½½ä¸­...</div>
                <div id="empty" class="empty" style="display: none;">æš‚æ— APIå¯†é’¥ï¼Œè¯·æ·»åŠ </div>
                <table id="keysTable" style="display: none;">
                    <thead>
                        <tr>
                            <th style="width: 50px; min-width: 50px;">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" title="å…¨é€‰/å–æ¶ˆå…¨é€‰">
                            </th>
                            <th style="width: 70px; min-width: 70px;">åºå·</th>
                            <th style="width: 250px; min-width: 250px;">API Key</th>
                            <th style="width: 100px; min-width: 100px;">å¯ç”¨çŠ¶æ€</th>
                            <th style="width: 100px; min-width: 100px;">ä½™é¢</th>
                            <th style="width: 100px; min-width: 100px;">è°ƒç”¨æ¬¡æ•°</th>
                            <th style="width: 170px; min-width: 170px;">åˆ›å»ºæ—¶é—´</th>
                            <th style="width: 170px; min-width: 170px;">æœ€åä½¿ç”¨</th>
                            <th style="width: 100px; min-width: 100px;">é”™è¯¯æ¬¡æ•°</th>
                            <th style="width: 340px; min-width: 340px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="keysTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ä¸»é¢˜ç®¡ç† - ç«‹å³æ‰§è¡Œï¼Œé¿å…é—ªçƒ
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            }

            function updateThemeIcon(theme) {
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
                    themeToggle.title = theme === 'dark' ? 'åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼';
                }
            }

            // æš´éœ²ç»™å…¨å±€
            window.toggleTheme = toggleTheme;
            window.updateThemeIcon = updateThemeIcon;
            
            // DOMåŠ è½½ååˆå§‹åŒ–å›¾æ ‡
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => updateThemeIcon(savedTheme));
            } else {
                updateThemeIcon(savedTheme);
            }
        })();

        // è·å–å­˜å‚¨çš„token
        function getAuthToken() {
            return localStorage.getItem('admin_token');
        }

        // è®¾ç½®token
        function setAuthToken(token) {
            localStorage.setItem('admin_token', token);
        }

        // æ¸…é™¤token
        function clearAuthToken() {
            localStorage.removeItem('admin_token');
        }

        // è·å–è¯·æ±‚å¤´ï¼ˆå¸¦è®¤è¯ä¿¡æ¯ï¼‰
        function getAuthHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            return headers;
        }

        // å¤„ç†401é”™è¯¯ï¼ˆéœ€è¦é‡æ–°éªŒè¯ï¼‰
        function handleAuthError() {
            clearAuthToken();
            showPasswordModal();
            showAlert('éœ€è¦é‡æ–°éªŒè¯å¯†ç ', 'error');
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¯†ç 
        async function checkAuth() {
            try {
                const response = await fetch('/api/manage/check-auth');
                const result = await response.json();
                
                if (result.success && result.requiresPassword) {
                    // éœ€è¦å¯†ç ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„token
                    const token = getAuthToken();
                    if (token) {
                        // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆï¼ˆé€šè¿‡å°è¯•è·å–API keysï¼‰
                        try {
                            const verifyResponse = await fetch('/api/manage/api-keys', {
                                headers: getAuthHeaders()
                            });
                            if (verifyResponse.ok) {
                                // tokenæœ‰æ•ˆï¼Œæ˜¾ç¤ºä¸»å†…å®¹å¹¶åŠ è½½æ•°æ®
                                showMainContent();
                                loadApiKeys();
                                return;
                            } else if (verifyResponse.status === 401) {
                                // tokenæ— æ•ˆï¼Œæ¸…é™¤å¹¶æ˜¾ç¤ºå¯†ç è¾“å…¥
                                clearAuthToken();
                                showPasswordModal();
                                return;
                            }
                        } catch (verifyError) {
                            // éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤tokenå¹¶æ˜¾ç¤ºå¯†ç è¾“å…¥
                            clearAuthToken();
                            showPasswordModal();
                            return;
                        }
                    }
                    // æ²¡æœ‰tokenï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
                    showPasswordModal();
                } else {
                    currentKeysData = [];
                    // ä¸éœ€è¦å¯†ç ï¼Œç›´æ¥æ˜¾ç¤ºä¸»å†…å®¹å¹¶åŠ è½½æ•°æ®
                    showMainContent();
                    loadApiKeys();
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä¹Ÿæ˜¾ç¤ºä¸»å†…å®¹å¹¶å°è¯•åŠ è½½æ•°æ®ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰
                showMainContent();
                loadApiKeys();
            }
        }

        // æ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('show');
        }

        // æ˜¾ç¤ºä¸»å†…å®¹
        function showMainContent() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            // åˆ›å»ºæ–°çš„alertå…ƒç´ 
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            
            // æ·»åŠ åˆ°å®¹å™¨
            alertContainer.appendChild(alert);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                alert.classList.remove('show');
                // ç­‰å¾…åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, 3000);
        }

        // æ˜¾ç¤ºå¯†ç é”™è¯¯æç¤º
        function showPasswordAlert(message, type = 'error') {
            const alert = document.getElementById('passwordAlert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
        }

        // å¯†ç éªŒè¯
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            try {
                const response = await fetch('/api/manage/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();
                if (result.success) {
                    // å¯†ç æ­£ç¡®ï¼Œä¿å­˜tokenå¹¶æ˜¾ç¤ºä¸»å†…å®¹
                    setAuthToken(password);
                    showPasswordAlert('éªŒè¯æˆåŠŸ', 'success');
                    setTimeout(() => {
                        showMainContent();
                        loadApiKeys();
                    }, 500);
                } else {
                    // å¯†ç é”™è¯¯
                    showPasswordAlert(result.message || 'å¯†ç é”™è¯¯', 'error');
                    document.getElementById('adminPassword').value = '';
                }
            } catch (error) {
                showPasswordAlert('éªŒè¯å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åŠ è½½API keysåˆ—è¡¨
        async function loadApiKeys() {
            try {
                // å¦‚æœä»£ç†é…ç½®æœªåŠ è½½ï¼Œå…ˆåŠ è½½ä»£ç†é…ç½®ï¼ˆç”¨äºæ˜¾ç¤ºä»£ç†éªŒè¯æŒ‰é’®ï¼‰
                if (proxyConfigs.length === 0 && typeof loadProxyConfig === 'function') {
                    try {
                        await loadProxyConfig();
                    } catch (e) {
                        // ä»£ç†é…ç½®åŠ è½½å¤±è´¥ä¸å½±å“APIå¯†é’¥åˆ—è¡¨åŠ è½½
                        console.warn('åŠ è½½ä»£ç†é…ç½®å¤±è´¥:', e);
                    }
                }
                
                const response = await fetch('/api/manage/api-keys', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (result.success && result.data.length > 0) {
                    currentKeysData = result.data;
                    document.getElementById('keysTable').style.display = 'table';
                    document.getElementById('empty').style.display = 'none';
                    renderTable(currentKeysData);
                } else {
                    document.getElementById('keysTable').style.display = 'none';
                    document.getElementById('empty').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showAlert('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ ¼å¼åŒ–æ—¶é—´ä¸ºä¸­å›½æ—¶åŒºï¼ˆUTC+8ï¼‰
        // æ•°æ®åº“å­˜å‚¨çš„æ˜¯ UTC æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:mm:ssï¼Œæ— æ—¶åŒºä¿¡æ¯ï¼‰
        // éœ€è¦å°†å…¶è§£æä¸º UTC æ—¶é—´ï¼Œç„¶åè½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼ˆUTC+8ï¼‰æ˜¾ç¤º
        function formatChinaTime(dateString) {
            if (!dateString) return '-';
            try {
                // å¦‚æœæ—¶é—´å­—ç¬¦ä¸²æ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:mm:ssï¼‰
                // SQLite çš„ CURRENT_TIMESTAMP è¿”å›çš„æ˜¯ UTC æ—¶é—´
                // éœ€è¦å°†å…¶è§£æä¸º UTC æ—¶é—´ï¼ˆ+00:00ï¼‰ï¼Œç„¶åè½¬æ¢ä¸ºä¸­å›½æ—¶åŒºæ˜¾ç¤º
                let date;
                if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(dateString)) {
                    // æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ssï¼Œæ²¡æœ‰æ—¶åŒºä¿¡æ¯
                    // å°†å…¶è§£æä¸º UTC æ—¶é—´ï¼ˆ+00:00ï¼‰
                    date = new Date(dateString + '+00:00');
                } else {
                    // å¦‚æœå·²ç»æœ‰æ—¶åŒºä¿¡æ¯ï¼Œç›´æ¥è§£æ
                    date = new Date(dateString);
                }
                
                // éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    return '-';
                }
                
                // ä½¿ç”¨ toLocaleString è½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼ˆAsia/Shanghaiï¼ŒUTC+8ï¼‰
                const options = {
                    timeZone: 'Asia/Shanghai',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                const chinaTimeString = date.toLocaleString('zh-CN', options);
                // æ ¼å¼åŒ–ä¸ºï¼šYYYY/MM/DD HH:mm:ss
                // toLocaleString è¿”å›æ ¼å¼å¯èƒ½æ˜¯ "YYYY/M/D HH:mm:ss"ï¼Œéœ€è¦è¡¥é›¶
                const parts = chinaTimeString.split(' ');
                const datePart = parts[0].split('/');
                const timePart = parts[1].split(':');
                const year = datePart[0];
                const month = datePart[1].padStart(2, '0');
                const day = datePart[2].padStart(2, '0');
                const hours = timePart[0].padStart(2, '0');
                const minutes = timePart[1].padStart(2, '0');
                const seconds = timePart[2].padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return '-';
            }
        }

        // å­˜å‚¨å®Œæ•´çš„API keysï¼ˆç”¨äºå¤åˆ¶ï¼‰
        let fullApiKeysMap = {};
        // å½“å‰æ­£åœ¨ä½¿ç”¨çš„API key ID
        let currentUsingKeyId = null;

        // è·å–å½“å‰æ­£åœ¨ä½¿ç”¨çš„API key ID
        async function fetchCurrentApiKey() {
            try {
                const response = await fetch('/api/manage/current-api-key', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    currentUsingKeyId = result.data.current_api_key_id;
                    // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
                    updateTableHighlight();
                }
            } catch (error) {
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
                console.warn('è·å–å½“å‰API keyå¤±è´¥:', error);
            }
        }

        // æ›´æ–°è¡¨æ ¼é«˜äº®æ˜¾ç¤º
        function updateTableHighlight() {
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('tr').forEach(row => {
                row.classList.remove('using-key');
            });
            
            // é«˜äº®å½“å‰ä½¿ç”¨çš„API key
            if (currentUsingKeyId) {
                const row = document.querySelector(`tr[data-key-id="${currentUsingKeyId}"]`);
                if (row) {
                    row.classList.add('using-key');
                }
            }
        }

        // ä¿å­˜å’Œæ¢å¤å‹¾é€‰çŠ¶æ€
        function saveCheckboxState() {
            const checkboxes = document.querySelectorAll('.key-checkbox');
            const checkedIds = new Set();
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    checkedIds.add(parseInt(cb.value));
                }
            });
            return checkedIds;
        }

        function restoreCheckboxState(checkedIds) {
            if (checkedIds && checkedIds.size > 0) {
                const checkboxes = document.querySelectorAll('.key-checkbox');
                checkboxes.forEach(cb => {
                    const id = parseInt(cb.value);
                    if (checkedIds.has(id)) {
                        cb.checked = true;
                    }
                });
                updateBatchDeleteButton();
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(keys) {
            const tbody = document.getElementById('keysTableBody');
            let totalBalance = 0;
            
            // ä¿å­˜å½“å‰å‹¾é€‰çŠ¶æ€
            const checkedIds = saveCheckboxState();
            
            // æ¸…ç©ºå¹¶é‡æ–°æ„å»ºå®Œæ•´keyæ˜ å°„
            fullApiKeysMap = {};
            keys.forEach(key => {
                if (key.full_api_key) {
                    fullApiKeysMap[key.id] = key.full_api_key;
                }
            });
            
            tbody.innerHTML = keys.map((key, index) => {
                // å¯ç”¨çŠ¶æ€æ˜¾ç¤º
                const isAvailable = key.is_available === true || key.is_available === 1 || key.is_available === null;
                const isError = key.status === 'error';
                let availableText = isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨';
                let availableClass = isAvailable ? 'status-active' : 'status-insufficient';
                
                // å¦‚æœçŠ¶æ€æ˜¯errorï¼Œæ˜¾ç¤ºå¼‚å¸¸çŠ¶æ€ï¼ˆä½†ç”¨æˆ·ä»ç„¶å¯ä»¥åˆ‡æ¢å¯ç”¨/ä¸å¯ç”¨ï¼‰
                if (isError) {
                    availableText = 'å¼‚å¸¸';
                    availableClass = 'status-error';
                }

                const createdDate = formatChinaTime(key.created_at);
                const lastUsed = formatChinaTime(key.last_used_at);
                
                // ä½™é¢æ˜¾ç¤ºï¼ˆé‡‘é¢ï¼‰
                let balanceDisplay = 'æœªæŸ¥è¯¢';
                let balanceClass = 'balance-unknown';
                let balanceValue = 0;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯APIå¯†é’¥æ— æ•ˆçš„æƒ…å†µï¼ˆé€šè¿‡last_erroråˆ¤æ–­ï¼Œä¸ä¾èµ–statusï¼‰
                const isInvalidKey = key.last_error && key.last_error.includes('æ— æ•ˆ');
                
                if (isInvalidKey) {
                    // å¯†é’¥æ— æ•ˆï¼Œæ˜¾ç¤º"å¯†é’¥æ— æ•ˆ"
                    balanceDisplay = 'å¯†é’¥æ— æ•ˆ';
                    balanceClass = 'balance-unknown';
                } else if (key.balance !== null && key.balance !== undefined) {
                    balanceValue = parseFloat(key.balance);
                    balanceDisplay = `Â¥${balanceValue.toFixed(2)}`;
                    balanceClass = balanceValue >= 0.5 ? 'balance-available' : 'balance-insufficient';
                    totalBalance += balanceValue;
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨çš„API key
                const isCurrentUsing = currentUsingKeyId === key.id;
                const usingIndicator = isCurrentUsing ? '<span style="color: #27ae60; font-weight: bold; margin-left: 5px;" title="æ­£åœ¨ä½¿ç”¨">â—</span>' : '';
                
                return `
                    <tr data-key-id="${key.id}" class="${isCurrentUsing ? 'using-key' : ''}">
                        <td style="text-align: center;">
                            <input type="checkbox" class="key-checkbox" value="${key.id}" onchange="updateBatchDeleteButton()">
                        </td>
                        <td style="text-align: center;">${index + 1}</td>
                        <td id="api-key-cell-${key.id}" style="cursor: pointer; user-select: none;" onclick="copyApiKey(${key.id})" title="ç‚¹å‡»å¤åˆ¶å®Œæ•´å¯†é’¥">${escapeHtml(key.api_key)}${usingIndicator}</td>
                        <td>
                            <span class="status-badge ${availableClass}" style="cursor: pointer;" onclick="toggleAvailability(${key.id})" title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€">${availableText}</span>
                        </td>
                        <td>
                            <span class="balance-text ${balanceClass}" id="balance-${key.id}">${balanceDisplay}</span>
                        </td>
                        <td style="text-align: center;">${key.call_count || 0}</td>
                        <td>${createdDate}</td>
                        <td>${lastUsed}</td>
                        <td style="text-align: center;">${key.error_count || 0}</td>
                        <td class="actions">
                            <div style="display: inline-flex; gap: 4px; align-items: center;">
                                <button class="btn btn-success btn-small" onclick="verifyApiKey(${key.id})" id="verify-btn-${key.id}">éªŒè¯</button>
                                ${proxyEnabled && proxyConfigs.length > 0 ? `
                                    <button class="btn btn-success btn-small" onclick="showProxyVerifyDialog(${key.id})" id="proxy-verify-btn-${key.id}" title="é€šè¿‡ä»£ç†éªŒè¯" style="padding: 6px 8px; font-size: 11px;">ğŸŒ</button>
                                ` : ''}
                            </div>
                            <button class="btn btn-info btn-small" onclick="queryBalance(${key.id})" id="query-btn-${key.id}">æŸ¥è¯¢ä½™é¢</button>
                            <button class="btn btn-warning btn-small" onclick="viewErrorLogs(${key.id})" title="æŸ¥çœ‹é”™è¯¯æ—¥å¿—">æ—¥å¿—</button>
                            <button class="btn btn-danger btn-small" onclick="deleteKey(${key.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // æ›´æ–°æ€»ä½™é¢æ˜¾ç¤º
            document.getElementById('totalBalance').textContent = `Â¥${totalBalance.toFixed(2)}`;
            
            // æ¢å¤å‹¾é€‰çŠ¶æ€
            restoreCheckboxState(checkedIds);
            
            // æ›´æ–°è¡¨æ ¼é«˜äº®
            updateTableHighlight();
        }

        // è®¡ç®—å¹¶æ˜¾ç¤ºå¯†é’¥æ•°é‡
        function updateKeyCount() {
            const textarea = document.getElementById('apiKeys');
            const countEl = document.getElementById('keyCount');
            const countNumberEl = document.getElementById('keyCountNumber');
            
            const text = textarea.value.trim();
            if (text) {
                const keys = text.split('\n')
                    .map(k => k.trim())
                    .filter(k => k && k.length > 0);
                const count = keys.length;
                
                if (count > 0) {
                    countNumberEl.textContent = count;
                    countEl.style.display = 'flex';
                } else {
                    countEl.style.display = 'none';
                }
            } else {
                countEl.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ·»åŠ å¯†é’¥æ¨¡æ€æ¡†
        function showAddModal() {
            document.getElementById('addModal').classList.add('show');
            setTimeout(() => {
                const textarea = document.getElementById('apiKeys');
                textarea.focus();
                // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬
                textarea.addEventListener('input', updateKeyCount);
                textarea.addEventListener('paste', () => {
                    setTimeout(updateKeyCount, 10);
                });
            }, 100);
        }

        // å…³é—­æ·»åŠ å¯†é’¥æ¨¡æ€æ¡†
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('show');
            document.getElementById('addForm').reset();
            document.getElementById('keyCount').style.display = 'none';
            const textarea = document.getElementById('apiKeys');
            textarea.removeEventListener('input', updateKeyCount);
            textarea.removeEventListener('paste', updateKeyCount);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('addModal').addEventListener('click', (e) => {
            if (e.target.id === 'addModal') {
                closeAddModal();
            }
        });

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('addModal').classList.contains('show')) {
                closeAddModal();
            }
        });

        // æ·»åŠ API keyï¼ˆæ”¯æŒæ‰¹é‡ï¼‰
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const apiKeys = document.getElementById('apiKeys').value.trim();

            if (!apiKeys) {
                showAlert('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }

            try {
                const response = await fetch('/api/manage/api-keys', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        api_keys: apiKeys
                    })
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    const message = result.added > 0 
                        ? `æˆåŠŸæ·»åŠ  ${result.added} ä¸ªå¯†é’¥${result.errors ? `ï¼Œ${result.errors.length} ä¸ªå¤±è´¥` : ''}`
                        : 'æ·»åŠ å¤±è´¥';
                    showAlert(message, result.added > 0 ? 'success' : 'error');
                    closeAddModal();
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        });

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.key-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBatchDeleteButton();
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®æ˜¾ç¤º
        function updateBatchDeleteButton() {
            const checkboxes = document.querySelectorAll('.key-checkbox:checked');
            const count = checkboxes.length;
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const batchQueryBtn = document.getElementById('batchQueryBtn');
            const selectedQueryCount = document.getElementById('selectedQueryCount');
            const selectedDeleteCount = document.getElementById('selectedDeleteCount');
            
            if (count > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                batchQueryBtn.style.display = 'inline-block';
                if (selectedQueryCount) selectedQueryCount.textContent = count;
                if (selectedDeleteCount) selectedDeleteCount.textContent = count;
            } else {
                batchDeleteBtn.style.display = 'none';
                batchQueryBtn.style.display = 'none';
            }
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            const allCheckboxes = document.querySelectorAll('.key-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            if (allCheckboxes.length > 0) {
                selectAllCheckbox.checked = allCheckboxes.length === count && count > 0;
            }
        }

        // æ‰¹é‡æŸ¥è¯¢ä½™é¢
        async function batchQueryBalances() {
            const checkboxes = document.querySelectorAll('.key-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (ids.length === 0) {
                showAlert('è¯·å…ˆé€‰æ‹©è¦æŸ¥è¯¢ä½™é¢çš„APIå¯†é’¥', 'error');
                return;
            }

            const batchQueryBtn = document.getElementById('batchQueryBtn');
            const originalText = batchQueryBtn.innerHTML;
            batchQueryBtn.disabled = true;
            batchQueryBtn.innerHTML = `æŸ¥è¯¢ä¸­... (${ids.length})`;

            let successCount = 0;
            let failCount = 0;
            const errors = [];

            // é€ä¸ªæŸ¥è¯¢ä½™é¢
            for (let i = 0; i < ids.length; i++) {
                const id = ids[i];
                const btn = document.getElementById(`query-btn-${id}`);
                const balanceEl = document.getElementById(`balance-${id}`);
                
                if (btn && balanceEl) {
                    try {
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        btn.disabled = true;
                        btn.textContent = 'æŸ¥è¯¢ä¸­...';
                        balanceEl.textContent = 'æŸ¥è¯¢ä¸­...';
                        
                        const response = await fetch(`/api/manage/api-keys/${id}/balance`, {
                            headers: getAuthHeaders()
                        });
                        
                        if (response.status === 401) {
                            handleAuthError();
                            batchQueryBtn.disabled = false;
                            batchQueryBtn.innerHTML = originalText;
                            return;
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            successCount++;
                            // æ˜¾ç¤ºä½™é¢é‡‘é¢
                            if (result.data.balance !== null && result.data.balance !== undefined) {
                                const balance = parseFloat(result.data.balance);
                                if (balance === 0 && result.data.message && result.data.message.includes('æ— æ•ˆ')) {
                                    balanceEl.textContent = 'å¯†é’¥æ— æ•ˆ';
                                    balanceEl.className = 'balance-text balance-unknown';
                                    balanceEl.title = result.data.message;
                                } else {
                                    balanceEl.textContent = `Â¥${balance.toFixed(2)}`;
                                    balanceEl.className = `balance-text ${
                                        balance >= 0.5 ? 'balance-available' : 'balance-insufficient'
                                    }`;
                                    if (result.data.message) {
                                        balanceEl.title = result.data.message;
                                    }
                                }
                            } else {
                                if (result.data.message && (result.data.message.includes('æ— æ•ˆ') || result.data.message.includes('å¤±è´¥'))) {
                                    balanceEl.textContent = result.data.message.length > 10 ? result.data.message.substring(0, 10) + '...' : result.data.message;
                                    balanceEl.className = 'balance-text balance-unknown';
                                    balanceEl.title = result.data.message;
                                } else {
                                    balanceEl.textContent = 'æ— æ³•è·å–';
                                    balanceEl.className = 'balance-text balance-unknown';
                                    if (result.data.message) {
                                        balanceEl.title = result.data.message;
                                    }
                                }
                            }
                        } else {
                            failCount++;
                            errors.push(`ID ${id}: ${result.message || 'æŸ¥è¯¢å¤±è´¥'}`);
                            balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                            balanceEl.className = 'balance-text balance-unknown';
                        }
                        
                        btn.disabled = false;
                        btn.textContent = 'æŸ¥è¯¢ä½™é¢';
                        
                        // æ›´æ–°è¿›åº¦
                        batchQueryBtn.innerHTML = `æŸ¥è¯¢ä¸­... (${i + 1}/${ids.length})`;
                    } catch (error) {
                        failCount++;
                        errors.push(`ID ${id}: ${error.message}`);
                        if (btn) {
                            btn.disabled = false;
                            btn.textContent = 'æŸ¥è¯¢ä½™é¢';
                        }
                        if (balanceEl) {
                            balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                            balanceEl.className = 'balance-text balance-unknown';
                        }
                    }
                }
            }

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            batchQueryBtn.disabled = false;
            batchQueryBtn.innerHTML = originalText;

            // æ˜¾ç¤ºç»“æœ
            if (successCount > 0) {
                showAlert(`æˆåŠŸæŸ¥è¯¢ ${successCount} ä¸ªä½™é¢${failCount > 0 ? `ï¼Œ${failCount} ä¸ªå¤±è´¥` : ''}`, failCount > 0 ? 'error' : 'success');
            } else {
                showAlert('æ‰€æœ‰æŸ¥è¯¢éƒ½å¤±è´¥äº†', 'error');
            }

            // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°æ€»ä½™é¢
            loadApiKeys();
        }

        // æ‰¹é‡åˆ é™¤API key
        async function batchDeleteKeys() {
            const checkboxes = document.querySelectorAll('.key-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (ids.length === 0) {
                showAlert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„APIå¯†é’¥', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªAPIå¯†é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch('/api/manage/api-keys/batch-delete', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ ids: ids })
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showAlert(`æˆåŠŸåˆ é™¤ ${result.deleted || ids.length} ä¸ªAPIå¯†é’¥${result.errors ? `ï¼Œ${result.errors.length} ä¸ªå¤±è´¥` : ''}`, 'success');
                    // æ¸…é™¤æ‰€æœ‰å¤é€‰æ¡†
                    document.getElementById('selectAll').checked = false;
                    updateBatchDeleteButton();
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤API key
        async function deleteKey(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå¯†é’¥å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/manage/api-keys/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showAlert('åˆ é™¤æˆåŠŸ');
                    loadApiKeys();
                } else {
                    showAlert(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éªŒè¯APIå¯†é’¥ï¼ˆå¯ä»¥é€‰æ‹©æ˜¯å¦ä½¿ç”¨ä»£ç†ï¼‰
        async function verifyApiKey(id, proxyId = null) {
            const btn = document.getElementById(`verify-btn-${id}`);
            if (!btn) return;
            
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'éªŒè¯ä¸­';
            
            try {
                const requestBody = {};
                if (proxyId) {
                    requestBody.proxyId = proxyId;
                }
                
                const response = await fetch(`/api/manage/api-keys/${id}/verify`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const proxyNote = proxyId ? ` (é€šè¿‡ä»£ç†éªŒè¯)` : '';
                    showAlert(result.message || 'éªŒè¯æˆåŠŸ' + proxyNote, 'success');
                    await loadApiKeys();
                } else {
                    showAlert(result.message || 'éªŒè¯å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('éªŒè¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // æ˜¾ç¤ºä»£ç†éªŒè¯é€‰æ‹©å¯¹è¯æ¡†
        function showProxyVerifyDialog(keyId) {
            showProxySelectDialog(keyId);
        }

        function showProxySelectDialog(keyId) {
            closeProxySelectDialog();
            const dialog = document.createElement('div');
            dialog.id = 'proxySelectDialog';
            dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1003;';
            const proxyListHtml = proxyConfigs.length > 0 ? `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; color: var(--text-primary); font-weight: 600; font-size: 14px;">é€šè¿‡ä»£ç†éªŒè¯ï¼š</label>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${proxyConfigs.map(proxy => {
                            const authInfo = proxy.username ? ` (${proxy.username}:***)` : ' (æ— éœ€è®¤è¯)';
                            const isAvailable = proxy.is_available === 1;
                            const statusBadge = isAvailable 
                                ? '<span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 6px;">å¯ç”¨</span>'
                                : '<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 6px;">ä¸å¯ç”¨</span>';
                            const verifyInfo = proxy.verify_ip ? ` - ${proxy.verify_ip} ${proxy.verify_address || ''}` : (proxy.verifyInfo ? ` - ${proxy.verifyInfo.ip || ''} ${proxy.verifyInfo.address || ''}` : '');
                            const latencyInfo = proxy.verify_latency ? `<div style="font-size: 11px; opacity: 0.85;">å»¶è¿Ÿ: ${proxy.verify_latency}ms</div>` : '';
                            return `
                                <button onclick="verifyApiKeyWithProxy(${keyId}, ${proxy.id})" 
                                        style="width: 100%; padding: 12px; margin-bottom: 8px; background: ${isAvailable ? 'var(--btn-info-bg)' : '#95a5a6'}; color: white; border: none; border-radius: 6px; cursor: ${isAvailable ? 'pointer' : 'not-allowed'}; font-size: 13px; text-align: left; opacity: ${isAvailable ? '1' : '0.7'};"
                                        ${!isAvailable ? 'disabled title="è¯¥ä»£ç†å½“å‰ä¸å¯ç”¨"' : ''}>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <strong>${proxy.type.toUpperCase()}</strong> ${proxy.host}:${proxy.port}${authInfo}${statusBadge}
                                            ${verifyInfo ? `<div style="font-size: 11px; margin-top: 4px; opacity: 0.9;">${verifyInfo}</div>` : ''}
                                            ${latencyInfo}
                                        </div>
                                        <span style="font-size: 16px;">ğŸŒ</span>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">æš‚æ— å¯ç”¨ä»£ç†é…ç½®</p>';

            dialog.innerHTML = `
                <div style="background: var(--container-bg); padding: 25px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: var(--shadow-lg);">
                    <h3 style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px;">ğŸŒ é€‰æ‹©éªŒè¯æ–¹å¼</h3>
                    <div style="margin-bottom: 20px;">
                        <button onclick="handleDirectVerify(${keyId})" 
                                style="width: 100%; padding: 12px; margin-bottom: 10px; background: var(--btn-primary-bg); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>ğŸ”—</span>
                            <span>ç›´æ¥éªŒè¯ï¼ˆä¸ä½¿ç”¨ä»£ç†ï¼‰</span>
                        </button>
                    </div>
                    ${proxyListHtml}
                    <button onclick="closeProxySelectDialog()" 
                            style="width: 100%; padding: 10px; background: var(--table-header-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 14px;">
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    closeProxySelectDialog();
                }
            });
            document.body.appendChild(dialog);
        }

        function closeProxySelectDialog() {
            const dialog = document.getElementById('proxySelectDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        function handleDirectVerify(keyId) {
            closeProxySelectDialog();
            verifyApiKey(keyId, null);
        }

        // é€šè¿‡ä»£ç†éªŒè¯APIå¯†é’¥
        async function verifyApiKeyWithProxy(keyId, proxyId) {
            closeProxySelectDialog();
            await verifyApiKey(keyId, proxyId);
        }

        // æŸ¥è¯¢ä½™é¢
        async function queryBalance(id) {
            const btn = document.getElementById(`query-btn-${id}`);
            const balanceEl = document.getElementById(`balance-${id}`);
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';
            balanceEl.textContent = 'æŸ¥è¯¢ä¸­...';
            
            try {
                const response = await fetch(`/api/manage/api-keys/${id}/balance`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // æ˜¾ç¤ºä½™é¢é‡‘é¢
                    if (result.data.balance !== null && result.data.balance !== undefined) {
                        const balance = parseFloat(result.data.balance);
                        // æ£€æŸ¥æ˜¯å¦æ˜¯APIå¯†é’¥æ— æ•ˆçš„æƒ…å†µï¼ˆä½™é¢ä¸º0ä¸”messageåŒ…å«"æ— æ•ˆ"ï¼‰
                        if (balance === 0 && result.data.message && result.data.message.includes('æ— æ•ˆ')) {
                            balanceEl.textContent = 'å¯†é’¥æ— æ•ˆ';
                            balanceEl.className = 'balance-text balance-unknown';
                            balanceEl.title = result.data.message;
                        } else {
                            balanceEl.textContent = `Â¥${balance.toFixed(2)}`;
                            balanceEl.className = `balance-text ${
                                balance >= 0.5 ? 'balance-available' : 'balance-insufficient'
                            }`;
                            if (result.data.message) {
                                balanceEl.title = result.data.message;
                            }
                        }
                    } else {
                        // å¦‚æœmessageåŒ…å«é”™è¯¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        if (result.data.message && (result.data.message.includes('æ— æ•ˆ') || result.data.message.includes('å¤±è´¥'))) {
                            balanceEl.textContent = result.data.message.length > 10 ? result.data.message.substring(0, 10) + '...' : result.data.message;
                            balanceEl.className = 'balance-text balance-unknown';
                            balanceEl.title = result.data.message;
                        } else {
                            balanceEl.textContent = 'æ— æ³•è·å–';
                            balanceEl.className = 'balance-text balance-unknown';
                            if (result.data.message) {
                                balanceEl.title = result.data.message;
                            }
                        }
                    }
                    showAlert(result.data.message);
                    // å¦‚æœçŠ¶æ€å˜åŒ–ï¼Œé‡æ–°åŠ è½½åˆ—è¡¨
                    setTimeout(() => loadApiKeys(), 500);
                } else {
                    balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                    balanceEl.className = 'balance-text balance-unknown';
                    showAlert(result.message || 'æŸ¥è¯¢å¤±è´¥', 'error');
                }
            } catch (error) {
                balanceEl.textContent = 'æŸ¥è¯¢å¤±è´¥';
                balanceEl.className = 'balance-text balance-unknown';
                showAlert('æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢ä½™é¢';
            }
        }

        // å¤åˆ¶API key
        async function copyApiKey(keyId) {
            // ä»æ˜ å°„ä¸­è·å–å®Œæ•´çš„API key
            const fullKey = fullApiKeysMap[keyId];
            if (!fullKey) {
                showAlert('æ— æ³•è·å–å®Œæ•´å¯†é’¥', 'error');
                return;
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„tdå…ƒç´ ç”¨äºè§†è§‰åé¦ˆ
            const targetElement = document.getElementById(`api-key-cell-${keyId}`);
            
            try {
                // ä½¿ç”¨Clipboard APIå¤åˆ¶
                await navigator.clipboard.writeText(fullKey);
                
                // è§†è§‰åé¦ˆï¼šä¸´æ—¶æ”¹å˜æ–‡æœ¬
                if (targetElement) {
                    const originalText = targetElement.textContent;
                    targetElement.textContent = 'å·²å¤åˆ¶ï¼';
                    targetElement.style.color = '#27ae60';
                    targetElement.style.fontWeight = '600';
                    
                    setTimeout(() => {
                        targetElement.textContent = originalText;
                        targetElement.style.color = '';
                        targetElement.style.fontWeight = '';
                    }, 1500);
                }
                
                showAlert('APIå¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = fullKey;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    if (targetElement) {
                        const originalText = targetElement.textContent;
                        targetElement.textContent = 'å·²å¤åˆ¶ï¼';
                        targetElement.style.color = '#27ae60';
                        targetElement.style.fontWeight = '600';
                        
                        setTimeout(() => {
                            targetElement.textContent = originalText;
                            targetElement.style.color = '';
                            targetElement.style.fontWeight = '';
                        }, 1500);
                    }
                    
                    showAlert('APIå¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }

        // åˆ‡æ¢å¯ç”¨çŠ¶æ€
        async function toggleAvailability(id) {
            try {
                const response = await fetch(`/api/manage/api-keys/${id}/toggle-availability`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    // ç«‹å³é‡æ–°åŠ è½½åˆ—è¡¨ï¼Œæ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                    await loadApiKeys();
                } else {
                    showAlert(result.message || 'åˆ‡æ¢å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        const logModalState = {
            apiKeyId: null,
            page: 1,
            pageSize: 15,
            total: 0,
            totalPages: 1,
            records: [],
            loading: false
        };

        function updateLogSubtitle(id) {
            const subtitle = document.getElementById('logSubtitle');
            if (subtitle) {
                // ç¡®ä¿idæ˜¯æ•°å­—ç±»å‹
                const numericId = typeof id === 'string' ? parseInt(id, 10) : id;
                
                // ä»currentKeysDataä¸­æŸ¥æ‰¾å¯¹åº”çš„API Keyï¼ˆç¡®ä¿ç±»å‹ä¸€è‡´ï¼‰
                const apiKey = currentKeysData.find(key => {
                    const keyId = typeof key.id === 'string' ? parseInt(key.id, 10) : key.id;
                    return keyId === numericId;
                });
                
                if (apiKey) {
                    // æ ¼å¼åŒ–API Keyæ˜¾ç¤ºï¼ˆå‰8ä½...å4ä½ï¼‰
                    const formatApiKey = (key) => {
                        if (!key) return '-';
                        if (key.length <= 12) return key;
                        return `${key.substring(0, 8)}...${key.substring(key.length - 4)}`;
                    };
                    const formattedKey = formatApiKey(apiKey.api_key || apiKey.full_api_key);
                    subtitle.textContent = `ID ${numericId} => ${formattedKey}`;
                } else {
                    subtitle.textContent = `ID ${numericId} => æœªçŸ¥`;
                }
            }
        }

        async function viewErrorLogs(id) {
            logModalState.apiKeyId = id;
            logModalState.page = 1;
            logModalState.records = [];
            logModalState.total = 0;
            logModalState.totalPages = 1;
            logModalState.loading = false;
            updateLogSubtitle(id);
            document.getElementById('logModal').style.display = 'flex';
            setLogTableMessage('åŠ è½½ä¸­...');
            updateLogPagination(); // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            await loadApiKeyLogs(1);
        }

        async function loadApiKeyLogs(page = logModalState.page) {
            if (!logModalState.apiKeyId) return;
            logModalState.page = page;
            logModalState.loading = true;
            setLogTableMessage('åŠ è½½ä¸­...');
            try {
                const response = await fetch(`/api/manage/api-keys/${logModalState.apiKeyId}/logs?page=${logModalState.page}&pageSize=${logModalState.pageSize}`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleAuthError();
                    closeLogModal();
                    return;
                }

                const result = await response.json();
                if (!result.success) {
                    setLogTableMessage(result.message || 'åŠ è½½å¤±è´¥', true);
                    return;
                }

                logModalState.records = result.data || [];
                logModalState.total = result.pagination?.total || 0;
                logModalState.totalPages = result.pagination?.totalPages || 1;
                renderLogTableRows();
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                setLogTableMessage(`åŠ è½½å¤±è´¥ï¼š${error.message}`, true);
            } finally {
                logModalState.loading = false;
                updateLogPagination(); // ç¡®ä¿åœ¨loadingçŠ¶æ€æ”¹å˜åæ›´æ–°æŒ‰é’®çŠ¶æ€
            }
        }

        function setLogTableMessage(message, isError = false) {
            const tbody = document.getElementById('logTableBody');
            if (!tbody) return;
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="log-empty" style="${isError ? 'color:#e74c3c;' : ''}">${message}</td>
                </tr>
            `;
        }

        function renderLogTableRows() {
            const tbody = document.getElementById('logTableBody');
            if (!tbody) return;

            if (!logModalState.records.length) {
                setLogTableMessage('æš‚æ— æ—¥å¿—');
                return;
            }

            const rows = logModalState.records.map(log => {
                const statusClass = log.success ? 'status-success' : 'status-fail';
                // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ä»£ç†
                let hasProxy = false;
                if (log.proxy_info) {
                    if (typeof log.proxy_info === 'object') {
                        hasProxy = Object.keys(log.proxy_info).length > 0 && log.proxy_info.type;
                    } else if (typeof log.proxy_info === 'string') {
                        try {
                            const parsed = JSON.parse(log.proxy_info);
                            hasProxy = parsed && typeof parsed === 'object' && Object.keys(parsed).length > 0 && parsed.type;
                        } catch (e) {
                            hasProxy = log.proxy_info.trim().length > 0;
                        }
                    }
                }
                const proxyCell = hasProxy ? `<span class="status-success">æ˜¯</span>` : '';
                return `
                    <tr>
                        <td>${formatChinaTime(log.timestamp)}</td>
                        <td><span class="status-badge ${statusClass}">${log.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</span></td>
                        <td>${log.request_type || '-'}</td>
                        <td><span class="response-pill">${log.response_type || '-'}</span></td>
                        <td>${log.status_code ?? '-'}</td>
                        <td>${proxyCell}</td>
                        <td>${formatDurationValue(log.duration_ms)}</td>
                        <td>${log.model || 'æœªçŸ¥'}</td>
                        <td><button class="btn btn-info btn-small" style="padding: 6px 12px;" onclick="openLogDetail(${log.id})">è¯¦æƒ…</button></td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function updateLogPagination() {
            const info = document.getElementById('logPageInfo');
            if (info) {
                const totalPages = Math.max(1, logModalState.totalPages);
                info.textContent = `å…± ${logModalState.total} æ¡è®°å½•ï¼Œç¬¬ ${logModalState.page} / ${totalPages} é¡µ`;
            }

            const prevBtn = document.getElementById('logPrevPage');
            const nextBtn = document.getElementById('logNextPage');
            if (prevBtn) {
                prevBtn.disabled = logModalState.page <= 1 || logModalState.loading;
                prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
            }
            if (nextBtn) {
                nextBtn.disabled = logModalState.page >= logModalState.totalPages || logModalState.loading;
                nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
            }

            const pageSizeSelect = document.getElementById('logPageSizeSelect');
            if (pageSizeSelect) {
                pageSizeSelect.value = String(logModalState.pageSize);
                pageSizeSelect.disabled = logModalState.loading;
            }
        }

        function changeLogPage(delta) {
            if (logModalState.loading) {
                console.log('æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            const targetPage = logModalState.page + delta;
            if (targetPage < 1 || targetPage > logModalState.totalPages) {
                console.log('ç›®æ ‡é¡µç è¶…å‡ºèŒƒå›´:', targetPage);
                return;
            }
            console.log('åˆ‡æ¢åˆ°ç¬¬', targetPage, 'é¡µ');
            loadApiKeyLogs(targetPage);
        }
        
        // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œç¡®ä¿onclickå¯ä»¥è®¿é—®
        window.changeLogPage = changeLogPage;

        function changeLogPageSize(value) {
            const size = parseInt(value, 10);
            if (isNaN(size) || size <= 0) {
                console.log('æ— æ•ˆçš„é¡µé¢å¤§å°:', value);
                return;
            }
            console.log('æ›´æ”¹æ¯é¡µæ˜¾ç¤ºæ•°é‡ä¸º:', size);
            logModalState.pageSize = size;
            logModalState.page = 1;
            loadApiKeyLogs(1);
        }
        
        // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œç¡®ä¿onchangeå¯ä»¥è®¿é—®
        window.changeLogPageSize = changeLogPageSize;

        function closeLogModal() {
            document.getElementById('logModal').style.display = 'none';
            logModalState.apiKeyId = null;
            logModalState.records = [];
            closeLogDetailModal();
        }

        function openLogDetail(logId) {
            const log = logModalState.records.find(item => item.id === logId);
            if (!log) return;

            const detailModal = document.getElementById('logDetailModal');
            const detailContent = document.getElementById('logDetailContent');
            const detailData = log.detail || safeJsonParse(log.detail_raw) || { message: 'æ— è¯¦ç»†æ•°æ®' };
            const proxyText = formatProxyInfo(log.proxy_info);
            
            // åˆ†ç¦»è¿”å›ç»™å®¢æˆ·ç«¯å’Œä¸Šæ¸¸è¿”å›çš„æ•°æ®
            let clientResponse = null;
            let upstreamData = null;
            
            if (log.success) {
                // æˆåŠŸæ—¶ï¼šè¿”å›ç»™å®¢æˆ·ç«¯çš„æ˜¯responseï¼Œä¸Šæ¸¸è¿”å›çš„ä¹Ÿæ˜¯response
                // detailDataå¯èƒ½æ˜¯ { request: {...}, response: {...}, proxy: {...} } æˆ–ç›´æ¥çš„responseå¯¹è±¡
                // ä¼˜å…ˆä»responseå­—æ®µè·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•ä»é¡¶å±‚è·å–
                upstreamData = detailData.response || (detailData.choices ? detailData : null) || (detailData.usage ? detailData : null) || detailData;
                clientResponse = upstreamData;
            } else {
                // å¤±è´¥æ—¶ï¼šè¿”å›ç»™å®¢æˆ·ç«¯çš„æ˜¯é”™è¯¯ä¿¡æ¯ï¼Œä¸Šæ¸¸è¿”å›çš„æ˜¯error
                upstreamData = detailData.error || detailData;
                clientResponse = {
                    error: upstreamData,
                    message: 'è¯·æ±‚å¤±è´¥'
                };
            }
            
            // åˆå¹¶æ•°æ®ï¼šä»detailDataçš„å¤šä¸ªä½ç½®æ”¶é›†ä¿¡æ¯
            // åˆ›å»ºä¸€ä¸ªåˆå¹¶çš„æ•°æ®å¯¹è±¡ï¼Œä¼˜å…ˆä½¿ç”¨upstreamDataï¼Œç„¶åä»detailDataè¡¥å……
            const mergedData = upstreamData ? { ...upstreamData } : {};
            
            // ä»detailDataé¡¶å±‚è¡¥å……ç¼ºå¤±çš„å­—æ®µ
            if (detailData.usage && !mergedData.usage) {
                mergedData.usage = detailData.usage;
            }
            if (detailData.choices && !mergedData.choices) {
                mergedData.choices = detailData.choices;
            }
            if (detailData.id && !mergedData.id) {
                mergedData.id = detailData.id;
            }
            if (detailData.created && !mergedData.created) {
                mergedData.created = detailData.created;
            }
            if (detailData.model && !mergedData.model) {
                mergedData.model = detailData.model;
            }
            
            // å¦‚æœdetailData.responseå­˜åœ¨ï¼Œä¹Ÿå°è¯•ä»ä¸­æå–
            if (detailData.response) {
                if (detailData.response.usage && !mergedData.usage) {
                    mergedData.usage = detailData.response.usage;
                }
                if (detailData.response.choices && !mergedData.choices) {
                    mergedData.choices = detailData.response.choices;
                }
                if (detailData.response.id && !mergedData.id) {
                    mergedData.id = detailData.response.id;
                }
                if (detailData.response.created && !mergedData.created) {
                    mergedData.created = detailData.response.created;
                }
                if (detailData.response.model && !mergedData.model) {
                    mergedData.model = detailData.response.model;
                }
            }
            
            // ä½¿ç”¨åˆå¹¶åçš„æ•°æ®
            upstreamData = mergedData;
            
            // æ ¼å¼åŒ–APIå¯†é’¥æ˜¾ç¤ºï¼ˆéšè—ä¸­é—´éƒ¨åˆ†ï¼‰
            const formatApiKey = (key) => {
                if (!key) return '-';
                if (key.length <= 12) return key;
                return `${key.substring(0, 8)}...${key.substring(key.length - 4)}`;
            };
            
            // ä»ä¸Šæ¸¸æ•°æ®ä¸­æå–å®ç”¨ä¿¡æ¯ï¼ˆæ”¯æŒå®Œæ•´æ•°æ®å’Œæ‘˜è¦æ ¼å¼ï¼‰
            const extractUpstreamInfo = (data) => {
                const info = {};
                if (!data || typeof data !== 'object') return info;
                
                // æå–usageä¿¡æ¯ï¼ˆtokenä½¿ç”¨é‡ï¼‰
                if (data.usage) {
                    info.prompt_tokens = data.usage.prompt_tokens;
                    info.completion_tokens = data.usage.completion_tokens;
                    info.total_tokens = data.usage.total_tokens;
                    // è®¡ç®—tokenæ•ˆç‡ï¼ˆcompletion_tokens / total_tokensï¼‰
                    if (data.usage.total_tokens > 0) {
                        info.token_efficiency = ((data.usage.completion_tokens / data.usage.total_tokens) * 100).toFixed(1) + '%';
                    }
                }
                
                // æå–choicesä¿¡æ¯ï¼ˆæ”¯æŒå®Œæ•´æ ¼å¼å’Œæ‘˜è¦æ ¼å¼ï¼‰
                if (Array.isArray(data.choices) && data.choices.length > 0) {
                    const firstChoice = data.choices[0];
                    info.finish_reason = firstChoice.finish_reason;
                    
                    // æå–æ¶ˆæ¯ä¿¡æ¯
                    if (firstChoice.message) {
                        const msg = firstChoice.message;
                        info.role = msg.role;
                        
                        // å†…å®¹é•¿åº¦ï¼ˆæ”¯æŒå®Œæ•´contentå’Œæ‘˜è¦æ ¼å¼çš„content_lengthï¼‰
                        if (msg.content_length !== undefined) {
                            // æ‘˜è¦æ ¼å¼ï¼šç›´æ¥ä½¿ç”¨content_length
                            info.content_length = msg.content_length;
                            if (msg.content_parts) {
                                info.content_parts = msg.content_parts;
                            }
                        } else if (msg.content) {
                            // å®Œæ•´æ ¼å¼ï¼šè®¡ç®—é•¿åº¦
                            if (typeof msg.content === 'string') {
                                info.content_length = msg.content.length;
                            } else if (Array.isArray(msg.content)) {
                                // contentå¯èƒ½æ˜¯æ•°ç»„ï¼ˆå¤šæ¨¡æ€ï¼‰
                                info.content_length = msg.content.reduce((sum, item) => {
                                    if (item.text) return sum + item.text.length;
                                    if (item.type === 'text' && item.text) return sum + item.text.length;
                                    return sum;
                                }, 0);
                                info.content_parts = msg.content.length;
                            }
                        }
                        
                        // æ¨ç†å†…å®¹é•¿åº¦ï¼ˆæ”¯æŒå®Œæ•´æ ¼å¼å’Œæ‘˜è¦æ ¼å¼ï¼‰
                        if (msg.reasoning_length !== undefined) {
                            // æ‘˜è¦æ ¼å¼
                            info.reasoning_length = msg.reasoning_length;
                        } else if (msg.reasoning_content) {
                            // å®Œæ•´æ ¼å¼
                            info.reasoning_length = typeof msg.reasoning_content === 'string' 
                                ? msg.reasoning_content.length 
                                : 0;
                        }
                        
                        // å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼ˆæ”¯æŒå®Œæ•´æ ¼å¼å’Œæ‘˜è¦æ ¼å¼ï¼‰
                        if (msg.tool_calls && Array.isArray(msg.tool_calls)) {
                            info.tool_calls_count = msg.tool_calls.length;
                            info.has_tool_calls = true;
                            // æå–å·¥å…·åç§°åˆ—è¡¨
                            const toolNames = msg.tool_calls.map(tc => {
                                // æ”¯æŒå®Œæ•´æ ¼å¼å’Œæ‘˜è¦æ ¼å¼
                                return tc.function?.name || (tc.function && typeof tc.function === 'object' ? tc.function.name : null);
                            }).filter(Boolean);
                            if (toolNames.length > 0) {
                                info.tool_names = toolNames.join(', ');
                            }
                        } else {
                            info.has_tool_calls = false;
                        }
                    }
                }
                
                // æå–å…¶ä»–æœ‰ç”¨ä¿¡æ¯
                if (data.id) info.response_id = data.id;
                if (data.created) {
                    info.created_at = new Date(data.created * 1000).toLocaleString('zh-CN');
                    info.created_timestamp = data.created;
                }
                if (data.model) info.response_model = data.model;
                
                return info;
            };
            
            const upstreamInfo = extractUpstreamInfo(upstreamData);
            
            // è°ƒè¯•ï¼šè¾“å‡ºæ•°æ®ç»“æ„ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
            console.log('=== æ—¥å¿—è¯¦æƒ…è°ƒè¯•ä¿¡æ¯ ===');
            console.log('logå¯¹è±¡:', log);
            console.log('detailData:', detailData);
            console.log('upstreamData:', upstreamData);
            console.log('upstreamInfo:', upstreamInfo);
            console.log('========================');

            detailContent.innerHTML = `
                <div class="detail-section">
                    <h4>åŸºç¡€ä¿¡æ¯</h4>
                    <div class="detail-grid">
                        <div class="item-full"><label>æ¨¡å‹</label><span class="single-line">${log.model || 'æœªçŸ¥'}</span></div>
                        <div class="item"><label>æ—¶é—´</label><span class="single-line">${formatChinaTime(log.timestamp)}</span></div>
                        <div class="item"><label>çŠ¶æ€</label><span class="single-line">${log.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</span></div>
                        <div class="item"><label>çŠ¶æ€ç </label><span class="single-line">${log.status_code ?? '-'}</span></div>
                        <div class="item"><label>è€—æ—¶</label><span class="single-line">${formatDuration(log.duration_ms)}</span></div>
                        <div class="item"><label>å“åº”ç±»å‹</label><span class="single-line">${log.response_type || '-'}</span></div>
                        <div class="item"><label>å®¢æˆ·ç«¯IP</label><span class="single-line">${log.client_ip || 'æœªçŸ¥'}</span></div>
                        <div class="item"><label>ä»£ç†</label><span class="single-line">${proxyText}</span></div>
                        <div class="item"><label>APIéªŒè¯å¯†é’¥</label><span class="single-line" title="${log.client_api_key || '-'}">${formatApiKey(log.client_api_key)}</span></div>
                        <div class="item"><label>æ€»Tokenæ•°</label><span class="single-line">${upstreamInfo.total_tokens ? upstreamInfo.total_tokens.toLocaleString() : '-'}</span></div>
                        <div class="item"><label>Prompt Tokens</label><span class="single-line">${upstreamInfo.prompt_tokens ? upstreamInfo.prompt_tokens.toLocaleString() : '-'}</span></div>
                        <div class="item"><label>Completion Tokens</label><span class="single-line">${upstreamInfo.completion_tokens ? upstreamInfo.completion_tokens.toLocaleString() : '-'}</span></div>
                        <div class="item"><label>Tokenæ•ˆç‡</label><span class="single-line">${upstreamInfo.token_efficiency || '-'}</span></div>
                        <div class="item"><label>å®ŒæˆåŸå› </label><span class="single-line">${upstreamInfo.finish_reason || '-'}</span></div>
                        <div class="item"><label>å†…å®¹é•¿åº¦</label><span class="single-line">${upstreamInfo.content_length !== undefined ? upstreamInfo.content_length.toLocaleString() + ' å­—ç¬¦' : '-'}</span></div>
                        ${upstreamInfo.content_parts ? `<div class="item"><label>å†…å®¹éƒ¨åˆ†æ•°</label><span class="single-line">${upstreamInfo.content_parts}</span></div>` : ''}
                        ${upstreamInfo.reasoning_length !== undefined ? `<div class="item"><label>æ¨ç†å†…å®¹é•¿åº¦</label><span class="single-line">${upstreamInfo.reasoning_length.toLocaleString()} å­—ç¬¦</span></div>` : ''}
                        ${upstreamInfo.tool_calls_count ? `<div class="item"><label>å·¥å…·è°ƒç”¨æ•°</label><span class="single-line">${upstreamInfo.tool_calls_count}</span></div>` : ''}
                        ${upstreamInfo.tool_names ? `<div class="item"><label>å·¥å…·åç§°</label><span class="single-line" title="${upstreamInfo.tool_names}">${upstreamInfo.tool_names.length > 30 ? upstreamInfo.tool_names.substring(0, 30) + '...' : upstreamInfo.tool_names}</span></div>` : ''}
                        ${upstreamInfo.response_model && upstreamInfo.response_model !== log.model ? `<div class="item"><label>å“åº”æ¨¡å‹</label><span class="single-line" title="${upstreamInfo.response_model}">${upstreamInfo.response_model.length > 25 ? upstreamInfo.response_model.substring(0, 25) + '...' : upstreamInfo.response_model}</span></div>` : ''}
                        ${upstreamInfo.response_id ? `<div class="item"><label>å“åº”ID</label><span class="single-line" title="${upstreamInfo.response_id}">${upstreamInfo.response_id.length > 20 ? upstreamInfo.response_id.substring(0, 20) + '...' : upstreamInfo.response_id}</span></div>` : ''}
                    </div>
                </div>
                <div class="detail-section">
                    <h4>è¯·æ±‚ä¿¡æ¯</h4>
                    <div class="detail-grid">
                        <div class="item-inline-row">
                            <div class="item-inline"><label>è¯·æ±‚ç±»å‹</label><span class="single-line">${log.request_type || '-'}</span></div>
                            <div class="item-inline"><label>è¯·æ±‚ID</label><span class="single-line" title="${log.request_id || '-'}">${log.request_id ? (log.request_id.length > 30 ? log.request_id.substring(0, 30) + '...' : log.request_id) : '-'}</span></div>
                        </div>
                        <div class="item-full"><label>è¯·æ±‚è·¯å¾„</label><span class="url-text single-line" title="${log.full_request_path || log.request_path || '-'}">${log.full_request_path || log.request_path || '-'}</span></div>
                        <div class="item-full"><label>ä¸Šæ¸¸åœ°å€</label><span class="url-text single-line" title="${log.upstream_url || '-'}">${log.upstream_url || '-'}</span></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>è¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®</h4>
                    <div class="json-block">${escapeHtml(JSON.stringify(clientResponse || { message: 'æ— æ•°æ®' }, null, 2))}</div>
                </div>
                <div class="detail-section">
                    <h4>ä¸Šæ¸¸è¿”å›çš„æ•°æ®</h4>
                    <div class="json-block">${escapeHtml(JSON.stringify(upstreamData || { message: 'æ— æ•°æ®' }, null, 2))}</div>
                </div>
            `;

            detailModal.style.display = 'flex';
        }

        function closeLogDetailModal() {
            document.getElementById('logDetailModal').style.display = 'none';
        }

        function formatDurationValue(ms) {
            if (ms === null || ms === undefined) return '-';
            return ms.toLocaleString();
        }

        function formatDuration(ms) {
            if (ms === null || ms === undefined) return '-';
            return `${ms.toLocaleString()} ms`;
        }

        function formatProxyInfo(proxy) {
            if (!proxy) return 'æœªä½¿ç”¨';
            const type = proxy.type ? proxy.type.toUpperCase() : '';
            return `${type} ${proxy.host || '-'}:${proxy.port || '-'}`;
        }

        function safeJsonParse(value) {
            if (!value) return null;
            if (typeof value === 'object') return value;
            try {
                return JSON.parse(value);
            } catch (error) {
                return null;
            }
        }

        const logModalElement = document.getElementById('logModal');
        if (logModalElement) {
            logModalElement.addEventListener('click', (e) => {
                if (e.target === logModalElement) {
                    closeLogModal();
                }
            });
        }

        const logDetailElement = document.getElementById('logDetailModal');
        if (logDetailElement) {
            logDetailElement.addEventListener('click', (e) => {
                if (e.target === logDetailElement) {
                    closeLogDetailModal();
                }
            });
        }

        // å¯¼å‡ºæ‰€æœ‰API keys
        async function exportAllKeys() {
            try {
                const token = getAuthToken();
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/manage/api-keys/export', {
                    headers: headers
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                if (!response.ok) {
                    const result = await response.json();
                    showAlert(result.message || 'å¯¼å‡ºå¤±è´¥', 'error');
                    return;
                }

                // è·å–æ–‡ä»¶å†…å®¹
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'api_keys.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('å¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                showAlert('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢
        async function queryAllBalances() {
            const btn = document.getElementById('queryAllBtn');
            if (btn.disabled) return;
            
            try {
                // è·å–æ‰€æœ‰API keys
                const response = await fetch('/api/manage/api-keys', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    showAlert('æ²¡æœ‰å¯æŸ¥è¯¢çš„APIå¯†é’¥', 'error');
                    return;
                }
                
                const keys = result.data;
                btn.disabled = true;
                btn.textContent = `æŸ¥è¯¢ä¸­ (0/${keys.length})...`;
                
                let successCount = 0;
                let failCount = 0;
                
                // ä¾æ¬¡æŸ¥è¯¢æ¯ä¸ªAPI keyçš„ä½™é¢
                for (let i = 0; i < keys.length; i++) {
                    const key = keys[i];
                    btn.textContent = `æŸ¥è¯¢ä¸­ (${i + 1}/${keys.length})...`;
                    
                    try {
                        const balanceResponse = await fetch(`/api/manage/api-keys/${key.id}/balance`, {
                            headers: getAuthHeaders()
                        });
                        
                        if (balanceResponse.status === 401) {
                            handleAuthError();
                            btn.disabled = false;
                            btn.textContent = 'ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢';
                            return;
                        }
                        
                        const balanceResult = await balanceResponse.json();
                        
                        if (balanceResult.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                        
                        // æ¯ä¸ªæŸ¥è¯¢ä¹‹é—´ç¨å¾®å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                        if (i < keys.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    } catch (error) {
                        failCount++;
                        console.error(`æŸ¥è¯¢ API Key ${key.id} ä½™é¢å¤±è´¥:`, error);
                    }
                }
                
                btn.disabled = false;
                btn.textContent = 'ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢';
                
                // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°ä½™é¢
                await loadApiKeys();
                
                showAlert(`æŸ¥è¯¢å®Œæˆï¼æˆåŠŸ: ${successCount}ï¼Œå¤±è´¥: ${failCount}`);
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'ä¸€é”®æŸ¥è¯¢æ‰€æœ‰ä½™é¢';
                showAlert('æ‰¹é‡æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·å–å¹¶æ˜¾ç¤ºAPIåœ°å€
        function updateApiUrl() {
            const protocol = window.location.protocol;
            const host = window.location.host;
            const apiUrl = `${protocol}//${host}/api/proxy/`;
            const apiUrlText = document.getElementById('apiUrlText');
            if (apiUrlText) {
                apiUrlText.textContent = apiUrl;
            }
        }

        // å¤åˆ¶APIåœ°å€
        async function copyApiUrl() {
            const protocol = window.location.protocol;
            const host = window.location.host;
            const apiUrl = `${protocol}//${host}/api/proxy/`;
            
            try {
                await navigator.clipboard.writeText(apiUrl);
                showAlert('APIåœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = apiUrl;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('APIåœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }

        // è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆæ¯10ç§’ï¼‰
        let autoRefreshInterval = null;
        let currentKeyRefreshInterval = null;
        
        function startAutoRefresh() {
            // æ¸…é™¤å·²æœ‰çš„å®šæ—¶å™¨
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (currentKeyRefreshInterval) {
                clearInterval(currentKeyRefreshInterval);
            }
            
            // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®
            autoRefreshInterval = setInterval(() => {
                // åªåœ¨é¡µé¢å¯è§æ—¶åˆ·æ–°ï¼ˆé¿å…åå°æ ‡ç­¾é¡µæµªè´¹èµ„æºï¼‰
                if (!document.hidden) {
                    loadApiKeys();
                }
            }, 10000); // 10ç§’ = 10000æ¯«ç§’
            
            // æ¯2ç§’åˆ·æ–°ä¸€æ¬¡å½“å‰ä½¿ç”¨çš„API keyï¼ˆæ›´é¢‘ç¹ï¼Œä»¥ä¾¿å®æ—¶æ˜¾ç¤ºï¼‰
            currentKeyRefreshInterval = setInterval(() => {
                // åªåœ¨é¡µé¢å¯è§æ—¶åˆ·æ–°
                if (!document.hidden) {
                    fetchCurrentApiKey();
                }
            }, 2000); // 2ç§’ = 2000æ¯«ç§’
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (currentKeyRefreshInterval) {
                clearInterval(currentKeyRefreshInterval);
                currentKeyRefreshInterval = null;
            }
        }
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶åœæ­¢è‡ªåŠ¨åˆ·æ–°
                stopAutoRefresh();
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh();
            }
        });

        // ç»‘å®šä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', window.toggleTheme);
            }
        });

        // ä»£ç†é…ç½®ç›¸å…³å‡½æ•°
        let proxyConfigs = [];
        let proxyEnabled = false;
        let editingProxyId = null;
        let currentKeysData = [];

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯å¹¶åŠ è½½åˆ—è¡¨
        checkAuth();
        // æ›´æ–°APIåœ°å€æ˜¾ç¤º
        updateApiUrl();
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        startAutoRefresh();
        // ç«‹å³è·å–ä¸€æ¬¡å½“å‰ä½¿ç”¨çš„API key
        fetchCurrentApiKey();
        // åŠ è½½ä»£ç†é…ç½®ï¼ˆç”¨äºæ˜¾ç¤ºä»£ç†éªŒè¯æŒ‰é’®ï¼‰- å¼‚æ­¥åŠ è½½ï¼Œä¸é˜»å¡é¡µé¢
        if (typeof loadProxyConfig === 'function') {
            loadProxyConfig();
        }

        async function showProxyModal() {
            const modal = document.getElementById('proxyModal');
            modal.classList.add('show');
            await loadProxyConfig();
        }

        function closeProxyModal() {
            const modal = document.getElementById('proxyModal');
            modal.classList.remove('show');
            editingProxyId = null;
        }

        async function loadProxyConfig() {
            try {
                const response = await fetch('/api/manage/proxy/config', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    proxyEnabled = result.data.enabled;
                    proxyConfigs = result.data.configs || [];
                    
                    document.getElementById('proxyEnabled').checked = proxyEnabled;
                    renderProxyList();
                    updateProxyStateInfo(result.data.activeState);
                    if (currentKeysData.length > 0) {
                        renderTable(currentKeysData);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä»£ç†é…ç½®å¤±è´¥:', error);
                showAlert('åŠ è½½ä»£ç†é…ç½®å¤±è´¥', 'error');
            }
        }

        async function toggleProxyEnabled() {
            const enabled = document.getElementById('proxyEnabled').checked;
            try {
                const response = await fetch('/api/manage/proxy/enabled', {
                    method: 'PUT',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    proxyEnabled = enabled;
                    showAlert(result.message, 'success');
                    if (currentKeysData.length > 0) {
                        renderTable(currentKeysData);
                    }
                } else {
                    document.getElementById('proxyEnabled').checked = !enabled;
                    showAlert(result.message || 'è®¾ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è®¾ç½®ä»£ç†å¼€å…³å¤±è´¥:', error);
                document.getElementById('proxyEnabled').checked = !enabled;
                showAlert('è®¾ç½®ä»£ç†å¼€å…³å¤±è´¥', 'error');
            }
        }

        function addProxyConfig() {
            editingProxyId = null;
            renderProxyForm();
        }

        function editProxyConfig(id) {
            editingProxyId = id;
            const proxy = proxyConfigs.find(p => p.id === id);
            if (proxy) {
                renderProxyForm(proxy);
            }
        }

        function cancelProxyEdit() {
            editingProxyId = null;
            renderProxyList();
        }

        function renderProxyForm(proxy = null) {
            const listDiv = document.getElementById('proxyList');
            listDiv.innerHTML = `
                <div style="background: var(--info-box-bg); border: 1px solid var(--info-box-border); border-radius: 8px; padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--text-primary);">${proxy ? 'ç¼–è¾‘ä»£ç†' : 'æ·»åŠ ä»£ç†'}</h4>
                    <div class="form-group">
                        <label>ä»£ç†ç±»å‹ *</label>
                        <select id="proxyType" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--container-bg); color: var(--text-primary);">
                            <option value="socks5" ${proxy && proxy.type === 'socks5' ? 'selected' : ''}>SOCKS5</option>
                            <option value="http" ${proxy && proxy.type === 'http' ? 'selected' : ''}>HTTP</option>
                            <option value="https" ${proxy && proxy.type === 'https' ? 'selected' : ''}>HTTPS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>IPåœ°å€ *</label>
                        <input type="text" id="proxyHost" value="${proxy ? proxy.host : ''}" placeholder="ä¾‹å¦‚: 127.0.0.1" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--container-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£ *</label>
                        <input type="number" id="proxyPort" value="${proxy ? proxy.port : ''}" placeholder="ä¾‹å¦‚: 1080" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--container-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="proxyUsername" value="${proxy ? (proxy.username || '') : ''}" placeholder="ç•™ç©ºåˆ™ä¸éœ€è¦è®¤è¯" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--container-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="password" id="proxyPassword" value="${proxy ? (proxy.password || '') : ''}" placeholder="ç•™ç©ºåˆ™ä¸éœ€è¦è®¤è¯" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--container-bg); color: var(--text-primary);">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="saveProxyConfig()" style="flex: 1;">ä¿å­˜</button>
                        <button class="btn" onclick="cancelProxyEdit()" style="background: var(--table-header-bg); color: var(--text-primary); border: 1px solid var(--border-color); flex: 1;">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
        }

        async function saveProxyConfig() {
            const type = document.getElementById('proxyType').value;
            const host = document.getElementById('proxyHost').value.trim();
            const port = document.getElementById('proxyPort').value.trim();
            const username = document.getElementById('proxyUsername').value.trim();
            const password = document.getElementById('proxyPassword').value.trim();

            if (!host || !port) {
                showAlert('IPåœ°å€å’Œç«¯å£ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                const url = editingProxyId 
                    ? `/api/manage/proxy/config/${editingProxyId}`
                    : '/api/manage/proxy/config';
                const method = editingProxyId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, host, port, username: username || null, password: password || null })
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    showAlert(editingProxyId ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
                    await loadProxyConfig();
                } else {
                    showAlert(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜ä»£ç†é…ç½®å¤±è´¥:', error);
                showAlert('ä¿å­˜ä»£ç†é…ç½®å¤±è´¥', 'error');
            }
        }

        async function deleteProxyConfig(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»£ç†é…ç½®å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/manage/proxy/config/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    showAlert('åˆ é™¤æˆåŠŸ', 'success');
                    await loadProxyConfig();
                } else {
                    showAlert(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ä»£ç†é…ç½®å¤±è´¥:', error);
                showAlert('åˆ é™¤ä»£ç†é…ç½®å¤±è´¥', 'error');
            }
        }

        function renderProxyList() {
            const listDiv = document.getElementById('proxyList');
            if (proxyConfigs.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">æš‚æ— ä»£ç†é…ç½®ï¼Œç‚¹å‡»"æ·»åŠ ä»£ç†"æŒ‰é’®æ·»åŠ </p>';
                return;
            }

            listDiv.innerHTML = proxyConfigs.map(proxy => {
                const authInfo = proxy.username ? ` (${proxy.username}:***)` : ' (æ— éœ€è®¤è¯)';
                const isAvailable = proxy.is_available === 1;
                const statusBadge = isAvailable 
                    ? '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">å¯ç”¨</span>'
                    : '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">ä¸å¯ç”¨</span>';
                
                // ä½¿ç”¨æ•°æ®åº“ä¸­çš„éªŒè¯ä¿¡æ¯æˆ–ä¸´æ—¶éªŒè¯ä¿¡æ¯
                const verifyInfo = proxy.verify_ip || proxy.verifyInfo ? `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            <div>IP: <strong style="color: var(--text-primary);">${proxy.verify_ip || proxy.verifyInfo?.ip || 'æœªçŸ¥'}</strong></div>
                            <div>åœ°å€: <strong style="color: var(--text-primary);">${proxy.verify_address || proxy.verifyInfo?.address || 'æœªçŸ¥'}</strong></div>
                            ${proxy.verifyInfo?.data2 ? `<div>æ•°æ®äºŒ: ${proxy.verifyInfo.data2}</div>` : ''}
                            ${(proxy.verify_latency || proxy.verifyInfo?.latency) ? `<div>å»¶è¿Ÿ: ${proxy.verify_latency || proxy.verifyInfo.latency}ms</div>` : ''}
                            ${proxy.verified_at ? `<div>éªŒè¯æ—¶é—´: ${new Date(proxy.verified_at).toLocaleString()}</div>` : ''}
                        </div>
                    </div>
                ` : '';
                return `
                    <div style="background: var(--info-box-bg); border: 1px solid var(--info-box-border); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div>
                                    <strong style="color: var(--text-primary);">${proxy.type.toUpperCase()}</strong>
                                    <span style="color: var(--text-secondary); margin-left: 10px;">${proxy.host}:${proxy.port}${authInfo}</span>
                                    ${statusBadge}
                                </div>
                                ${verifyInfo}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success" onclick="verifyProxyConfig(${proxy.id})" id="verify-proxy-${proxy.id}" style="padding: 4px 8px; font-size: 12px;">éªŒè¯</button>
                                <button class="btn btn-info" onclick="editProxyConfig(${proxy.id})" style="padding: 4px 8px; font-size: 12px;">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteProxyConfig(${proxy.id})" style="padding: 4px 8px; font-size: 12px;">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function verifyProxyConfig(id) {
            const btn = document.getElementById(`verify-proxy-${id}`);
            if (btn.disabled) return;
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'éªŒè¯ä¸­...';
            
            try {
                const response = await fetch(`/api/manage/proxy/config/${id}/verify`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError();
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    // æ›´æ–°ä»£ç†é…ç½®çš„éªŒè¯ä¿¡æ¯ï¼ˆä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼‰
                    await loadProxyConfig();
                    showAlert(`éªŒè¯æˆåŠŸï¼IP: ${result.data.ip}, åœ°å€: ${result.data.address}, å»¶è¿Ÿ: ${result.data.latency}ms`, 'success');
                } else {
                    // éªŒè¯å¤±è´¥ï¼Œä¹Ÿé‡æ–°åŠ è½½ä»¥æ›´æ–°çŠ¶æ€
                    await loadProxyConfig();
                    showAlert(`éªŒè¯å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('éªŒè¯ä»£ç†é…ç½®å¤±è´¥:', error);
                showAlert('éªŒè¯ä»£ç†é…ç½®å¤±è´¥', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function updateProxyStateInfo(state) {
            const stateInfo = document.getElementById('proxyStateInfo');
            const stateText = document.getElementById('proxyStateText');
            
            if (state && state.active_proxy_id) {
                const proxy = proxyConfigs.find(p => p.id === state.active_proxy_id);
                if (proxy) {
                    const expiresAt = new Date(state.expires_at);
                    const now = new Date();
                    const remainingMinutes = Math.ceil((expiresAt - now) / (1000 * 60));
                    
                    stateInfo.style.display = 'block';
                    stateText.textContent = `å½“å‰ä½¿ç”¨ä»£ç†: ${proxy.type.toUpperCase()} ${proxy.host}:${proxy.port}ï¼Œå°†åœ¨ ${remainingMinutes} åˆ†é’Ÿåæ¢å¤ä½¿ç”¨æœ¬åœ°IP`;
                } else {
                    stateInfo.style.display = 'none';
                }
            } else {
                stateInfo.style.display = 'none';
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('proxyModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'proxyModal') {
                closeProxyModal();
            }
        });
    </script>
</body>
</html>


